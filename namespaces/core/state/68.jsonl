{"_at":[1768758758478,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768719790402,0],"created_by":"darin@darinsmcstudio2.lan","description":"JSON paths build large strings via to_string_pretty (print_ok in src/cli/mod.rs and command-specific JSON outputs). Use serde_json::to_writer_pretty on a stdout lock and append newline.","id":"bd-rraj","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"CLI JSON output: stream to stdout to cut allocations","type":"chore"}
{"_at":[1768622429797,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Command opens database with foreign_keys=OFF\n- [ ] Detects all 5 types of orphaned references\n- [ ] Creates backup before making changes\n- [ ] All deletes happen in a single transaction\n- [ ] Transaction rolls back on any error\n- [ ] Dry-run mode shows what would be cleaned\n- [ ] JSON output includes all orphan details\n- [ ] Works on corrupted databases that won't open normally\n- [ ] Preserves backup file after completion","created_at":[1768622429797,0],"created_by":"darin@darinsmcstudio2.lan","description":"","design":"Port the database repair feature from Go beads to beads-rs.\n\n## Problem\n\nWhen the database has orphaned foreign key references (dependencies, labels, comments, events pointing to non-existent issues), migration invariant checks fail and prevent the database from opening. This creates a chicken-and-egg problem where `bd doctor --fix` can't run because it can't open the database.\n\n## Solution\n\nA standalone repair command that opens the database DIRECTLY, bypassing migration invariant checks, and cleans orphaned references.\n\n## Implementation approach\n\n**Location**: `src/cli/repair.rs` (new file)\n\n**Command structure**:\n```rust\npub struct RepairArgs {\n    #[arg(long)]\n    dry_run: bool,\n    #[arg(long)]\n    json: bool,\n    #[arg(long)]\n    path: Option<PathBuf>,  // defaults to current dir\n}\n```\n\n**Orphaned references to detect and clean**:\n1. Dependencies where issue_id doesn't exist\n2. Dependencies where depends_on_id doesn't exist (excluding external:xxx)\n3. Labels where issue_id doesn't exist\n4. Comments where issue_id doesn't exist\n5. Events where issue_id doesn't exist\n\n**Repair process**:\n1. Find .beads directory and database path\n2. Open SQLite directly (foreign_keys=OFF, bypass migration checks)\n3. Run detection queries for each orphan type\n4. If dry-run: report what would be cleaned\n5. If not dry-run:\n   - Create backup: `beads.db.pre-repair`\n   - Start transaction\n   - Execute DELETE statements for orphans\n   - Mark affected issues as dirty (for export)\n   - Commit transaction\n   - Run WAL checkpoint\n\n**Output**:\n```json\n{\n  \"database_path\": \"/path/to/.beads/beads.db\",\n  \"dry_run\": false,\n  \"orphan_counts\": {\n    \"dependencies_issue_id\": 3,\n    \"dependencies_depends_on\": 1,\n    \"labels\": 5,\n    \"comments\": 0,\n    \"events\": 2,\n    \"total\": 11\n  },\n  \"orphan_details\": { /* arrays of specific orphans */ },\n  \"status\": \"success\",\n  \"backup_path\": \"/path/to/.beads/beads.db.pre-repair\"\n}\n```\n\n## Files to reference\n\nGo implementation: `/Users/darin/Projects/beads-rs-macstudio/tmp/beads/cmd/bd/repair.go`\n\nKey SQL queries:\n```sql\n-- Orphaned deps (issue_id)\nSELECT d.issue_id, d.depends_on_id\nFROM dependencies d\nWHERE NOT EXISTS (SELECT 1 FROM issues WHERE id = d.issue_id)\n\n-- Orphaned deps (depends_on_id)\nSELECT d.issue_id, d.depends_on_id\nFROM dependencies d\nWHERE NOT EXISTS (SELECT 1 FROM issues WHERE id = d.depends_on_id)\n  AND d.depends_on_id NOT LIKE 'external:%'\n\n-- Similar for labels, comments, events\n```\n\n## Design notes\n\n- **Transaction safety**: All deletes in a single transaction. Rollback on any error.\n- **Backup first**: Always create backup before destructive ops. Fail fast if backup fails.\n- **Dirty tracking**: Mark parent issues dirty so exports stay consistent\n- **No migration layer**: This command bypasses the normal storage layer entirely\n- **Error recovery**: Preserve backup on error, print recovery instructions\n\n## Questions\n\n1. Should this be a daemon operation or direct SQLite access?\n   - Recommendation: Direct SQLite, daemon might not be running when repair is needed\n2. Do we need a --force flag to skip confirmation?\n3. Should we auto-run `bd doctor` after successful repair?","id":"bd-ze0x.15","labels":{"cc":{"max":{}},"entries":{"human-needed":[{"counter":6125257156869369387,"replica":"ffaccba2-fbaa-48c0-9cb1-ad2e2f8b25bd"}]}},"priority":2,"status":"open","title":"Implement bd repair command - Repair orphaned foreign key references with transaction safety","type":"feature"}
{"_at":[1768622478293,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768622478293,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nUsers need to monitor issue changes in real-time. Go beads lacks this feature but it's a natural UX enhancement.\n\n**Design**\nAdd `--watch` flag to `bd list` that:\n- Clears screen and re-renders list every N seconds (default 2s)\n- Uses `--interval` flag to customize refresh rate\n- Shows timestamp of last update at top\n- Exits on Ctrl+C (SIGINT)\n- Uses fsnotify/file watching for efficient change detection (optional optimization)\n\nExample usage:\n```bash\nbd list --status open --watch\nbd list --priority 0,1 --watch --interval 5s\n```\n\nDisplay format:\n```\nbd list (last updated: 2025-01-16 14:30:45)\n\n● bd-abc123 P0 [bug] Fix auth timeout\n○ bd-def456 P1 [feature] Add OAuth\n...\n\nPress Ctrl+C to exit\n```\n\n**Design Notes**\n- Use crossterm for terminal clearing and cursor control\n- Watch database file mtime for changes (avoid constant re-queries)\n- Combine with --pretty for best UX\n- --json mode incompatible with --watch (error)\n- Use tokio::time::interval for async refresh loop\n\n**Acceptance**\n- [ ] --watch flag refreshes list automatically\n- [ ] --interval controls refresh rate (default 2s)\n- [ ] Shows last update timestamp\n- [ ] Clears screen between refreshes\n- [ ] Exits cleanly on Ctrl+C\n- [ ] Errors if combined with --json\n- [ ] Works with all existing list filters\n\n**Files:**\n- `src/cli/list.rs`\n- `Cargo.toml` (add crossterm, notify crates)","id":"bd-ze0x.30","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"open","title":"bd list --watch for live-updating view","type":"feature"}
