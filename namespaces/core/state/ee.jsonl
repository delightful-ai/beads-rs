{"_at":[1768425885067,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768422079065,0],"created_by":"darin@darinsmcstudio2.lan","description":"Observed during benchmark: cargo test --test phase7_subscribe failed with phase7_subscribe_streams_events_in_order panicking at tests/phase7_subscribe.rs:170 (event). 18/19 passed. Likely flake or subscribe stream ordering/EOF issue; rerun with RUST_BACKTRACE=1 and add logging around StreamingClient::next_event/subscribe_stream.","id":"bd-2a5","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"phase7_subscribe_streams_events_in_order failed during benchmark","type":"bug"}
{"_at":[1768461466235,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768444212747,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nREALTIME_PLAN §0.10 defines LocalFsync as fsync of the active segment file after each append. Current SegmentWriter::append uses File::sync_data, which may omit metadata durability (file length/mtime) on some platforms.\n\nEvidence:\n- src/daemon/wal/segment.rs:252–260 calls self.file.sync_data().\n\n**Why this violates plan**\nLocalFsync semantics require full fsync of the file to guarantee record durability.\n\n**Acceptance**\n- [ ] Use sync_all (fsync) for LocalFsync record durability.\n- [ ] Document/benchmark any performance impact and keep directory fsync only on rotation.","id":"bd-3m5.89","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"WAL append uses sync_data instead of full fsync","type":"bug"}
{"_at":[1769579564772,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769309224115,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nCLI handlers manually construct validation errors with repetitive boilerplate:\n\n```rust\n// src/cli/commands/create.rs:17-20\nError::Op(crate::daemon::OpError::ValidationFailed {\n    field: \"create\".into(),\n    reason: \"cannot specify both title and --file flag\".into(),\n})\n\n// src/cli/commands/update.rs:26-29\nError::Op(crate::daemon::OpError::ValidationFailed {\n    field: \"reason\".into(),\n    reason: \"--reason requires --status=closed\".into(),\n})\n\n// src/cli/commands/dep.rs:9-12\nError::Op(crate::daemon::OpError::ValidationFailed {\n    field: \"dep\".into(),\n    reason: msg,\n})\n```\n\nThis pattern appears 10+ times across handlers. No helper exists despite `normalize_bead_id_for()` in mod.rs showing the pattern works.\n\n**Design**\nAdd a helper function in `src/cli/mod.rs` (near line 1351 where similar helpers exist):\n\n```rust\n/// Create a validation error for CLI argument validation\npub(crate) fn validation_error(field: impl Into<String>, reason: impl Into<String>) -> Error {\n    Error::Op(crate::daemon::OpError::ValidationFailed {\n        field: field.into(),\n        reason: reason.into(),\n    })\n}\n```\n\nThen replace all manual constructions:\n```rust\n// Before\nreturn Err(Error::Op(crate::daemon::OpError::ValidationFailed {\n    field: \"create\".into(),\n    reason: \"cannot specify both title and --file flag\".into(),\n}));\n\n// After\nreturn Err(validation_error(\"create\", \"cannot specify both title and --file flag\"));\n```\n\n**Acceptance**\n- [ ] `validation_error()` helper added to src/cli/mod.rs\n- [ ] All `Error::Op(OpError::ValidationFailed { ... })` patterns in src/cli/commands/ replaced\n- [ ] Helper is pub(crate) so command modules can use it\n- [ ] cargo clippy passes\n- [ ] cargo test passes\n\n**Files:** src/cli/mod.rs, src/cli/commands/create.rs, src/cli/commands/update.rs, src/cli/commands/dep.rs, src/cli/commands/label.rs","id":"bd-uzwo","labels":{"cc":{"max":{}},"entries":{}},"notes":[{"at":[1769579440594,0],"author":"darin@darins-Mac-Studio-2.local","content":"Rendering stays in command files; helper should only reduce validation error boilerplate.","id":"go-comment-bd-uzwo-1"},{"at":[1769579564772,0],"author":"darin@darinsmcstudio2.lan","content":"Rendering stays in command files; helper should only reduce validation error boilerplate.","id":"legacy-notes"}],"priority":2,"status":"closed","title":"Extract ValidationError helper for CLI handlers","type":"chore"}
{"_at":[1769511605294,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] All query handlers in `crates/beads-rs/src/daemon/query_executor.rs` call a shared `with_read_ctx` (or equivalent) helper.\n- [ ] No query method manually repeats the full read preamble sequence.\n- [ ] Read gate behavior, error mapping, and namespace selection are unchanged.\n- [ ] `query_status` still includes repo state–derived warnings/fields and uses the helper with `want_repo_state`.\n- [ ] `cargo test` passes.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769481339433,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`crates/beads-rs/src/daemon/query_executor.rs` repeats the same read setup in nearly every query:\n`ensure_repo_fresh → normalize_read_consistency → check_read_gate → store_runtime/state lookup`.\nThis repetition adds risk: any change to read-gate, read consistency normalization, or state lookup must be edited in many places, and the error mapping must stay identical everywhere.\n\n**Design**\nIntroduce a single helper that performs the standard read preamble and hands a normalized context into a closure.\n\n1) Add a lightweight context struct local to `query_executor.rs`:\n```rs\nstruct ReadCtx<'a> {\n    remote: LoadedStore,\n    read: NormalizedReadConsistency,\n    store: &'a StoreRuntime,\n    state: &'a CanonicalState,\n    repo_state: Option<&'a GitLaneState>,\n}\n```\n- `repo_state` is optional to support `query_status` (only it needs git lane details). Other queries can ignore it.\n- `state` should be the namespace-selected state (fall back to `CanonicalState::new()` if missing).\n\n2) Add helper on `Daemon` in `query_executor.rs`:\n```rs\nfn with_read_ctx<F>(\n    &mut self,\n    repo: &Path,\n    read: ReadConsistency,\n    git_tx: &Sender<GitOp>,\n    want_repo_state: bool,\n    f: F,\n) -> Response\nwhere\n    F: for<'a> FnOnce(ReadCtx<'a>) -> Result<ResponsePayload, OpError>,\n```\nImplementation details:\n- Call `ensure_repo_fresh`, `normalize_read_consistency`, and `check_read_gate` in that order.\n- Pull `store_runtime` and compute `state` for `read.namespace()`.\n- If `want_repo_state` is true, fetch `git_lane_state` and include it.\n- Convert the closure’s `Result` into `Response::ok` / `Response::err_from` (preserving existing error mapping).\n\n3) Convert all `query_*` methods to use the helper:\n- `query_show`, `query_show_multiple`, `query_list`, `query_ready`, `query_dep_tree`, `query_dep_cycles`, `query_deps`, `query_notes`, `query_blocked`, `query_stale`, `query_count`, `query_deleted`, `query_epic_status`, `query_validate`.\n- `query_status` should pass `want_repo_state = true` and use `ctx.repo_state`.\n\n4) Remove duplicated preamble blocks from all queries.\n\n**Design Notes**\n- Keep behavior identical: same order of operations, same error returns.\n- Keep `CanonicalState::new()` fallback behavior for missing namespaces.\n- Avoid borrow checker pain by keeping the helper and `ReadCtx` inside `query_executor.rs` and using a closure (`for<'a>`) so `state`/`store` borrows don’t escape.\n\n**Files**\n- `crates/beads-rs/src/daemon/query_executor.rs`","id":"bd-xo3o","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"DRY read preamble in daemon query executor","type":"chore"}
