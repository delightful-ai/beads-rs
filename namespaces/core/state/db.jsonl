{"_at":[1768454029760,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768448953374,1],"darin@book"],"claim":[[1768453507109,1],"darin@book"],"description":[[1768448953374,1],"darin@book"],"design":[[1768448953374,1],"darin@book"],"estimated_minutes":[[1768448953374,1],"darin@book"],"external_ref":[[1768448953374,1],"darin@book"],"labels":[[1768448953374,1],"darin@book"],"priority":[[1768448953374,1],"darin@book"],"source_repo":[[1768448953374,1],"darin@book"],"title":[[1768448953374,1],"darin@book"],"type":[[1768448953374,1],"darin@book"]},"acceptance_criteria":"- [ ] Inbound session rejects EVENTS for namespaces not in incoming_namespaces.\n- [ ] Outbound streaming/hot cache only sends namespaces in accepted_namespaces.\n- [ ] Outbound WANT handling is scoped to accepted_namespaces.\n- [ ] Tests cover accept/reject behavior.\n\n**Files:** src/daemon/repl/session.rs, src/daemon/repl/manager.rs, src/daemon/repl/server.rs","assignee":"darin@book","assignee_at":[1768453507109,1],"assignee_expires":1768457107109,"closed_at":[1768454029760,1],"closed_by":"darin@book","created_at":[1768448953374,1],"created_by":"darin@book","description":"**Problem**\nInbound replication accepts EVENTS for any namespace, regardless of negotiated namespaces. Outbound replication continues to publish events for namespaces the peer did not accept. This breaks namespace policy invariants and makes the allowlist in HELLO/WELCOME advisory only.\n\n**Evidence**\n- src/daemon/repl/session.rs: handle_events() never checks frame.eid.namespace against peer.incoming_namespaces (stored on SessionPeer).\n- src/daemon/repl/manager.rs: run_peer_loop() filters outgoing events using offered_set (plan/offered), not the negotiated accepted_namespaces from session.peer().\n- src/daemon/repl/manager.rs: handle_want() has no allowed_set filter, so it can send events for namespaces the peer never accepted.\n\n**Why this hurts**\nNamespace policy is meant to be a hard boundary. Without enforcement, a misconfigured or malicious peer can ingest or receive data outside its allowed namespaces.","design":"**Design**\n1) Enforce inbound namespaces in Session::handle_events(): if namespace not in peer.incoming_namespaces, return an error payload (NamespacePolicyViolation or InvalidRequest) and close.\n2) Outbound: after handshake, derive accepted_set from session.peer().accepted_namespaces and use it for filtering pending events + hot cache + live stream. Replace offered_set usage.\n3) Update manager::handle_want() to accept an allowed_set (like server.rs) and ignore or error on wants outside accepted_set.\n4) Add tests for both directions (reject unexpected namespace; only send accepted namespaces).\n\nNote: inbound server already builds accepted_set; align outbound to use the negotiated set.","id":"bd-23h","labels":[],"priority":1,"status":"closed","title":"Replication does not enforce namespace allowlists","type":"bug"}
