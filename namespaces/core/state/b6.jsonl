{"_at":[1769568341138,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] It is impossible to call repl send paths with a non‑canonical frame at compile time.\n- [ ] The only conversion into a sendable frame performs canonical/sha validation.\n- [ ] `ReplMessage::Events` and send helpers use the verified type (not raw `EventFrameV1`).\n- [ ] Tests cover: non-canonical bytes rejected; sha mismatch rejected; canonical frame accepted.\n- [ ] `cargo test` passes.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769562850912,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`ReplMessage::Events` carries raw `EventFrameV1` values. The type does not encode that the bytes are canonical or that `sha256` matches the bytes. Today call sites *happen* to build frames from canonical sources, but nothing stops a future caller (or test harness) from constructing non-canonical frames and sending them. The compiler cannot help, and correctness depends on developer discipline.\n\nThis is a lie in the type system: `EventFrameV1` looks like a verified payload but is not. It violates parse-don’t-validate and creates scatter (every call site must remember to validate).\n\n**Impact**\n- Wire protocol can emit invalid frames (non-canonical bytes or wrong sha).\n- Downstream peers reject or diverge; hard to localize to the sender.\n- Future refactors can silently introduce invalid frames.\n\n**Files**\n- `crates/beads-core/src/event.rs` (EventFrameV1)\n- `crates/beads-rs/src/daemon/repl/manager.rs` / `server.rs` / `want.rs` (frame construction + send)\n- `crates/beads-rs/src/daemon/broadcast.rs` (BroadcastEvent bytes type)\n","design":"**Design (opinionated)**\nMake the type tell the truth: only canonical frames can be sent.\n\nOption A (preferred): parameterize or wrap frames by byte canonicality.\n- Introduce `CanonicalFrame` (or `VerifiedFrame`) that holds `EventBytes<Canonical>` and derived `sha256`.\n- Provide `impl From<VerifiedEvent<PrevVerified>> for CanonicalFrame` and `impl From<BroadcastEvent>` only if `BroadcastEvent` is also canonical.\n- Change `ReplMessage::Events` to hold `Vec<CanonicalFrame>` (or `Vec<EventFrameV1<Canonical>>` if you add a type parameter).\n- `encode_event_frame` accepts only canonical frames; `decode_event_frame` still yields raw frames which must be validated via `verify_event_frame` to become canonical.\n\nOption B (minimal): keep `EventFrameV1` wire type but add a strict newtype `SendableFrame` used by all send paths; `SendableFrame::try_from(EventFrameV1)` validates canonical bytes + sha match and is the only type accepted by send functions.\n\nIn both options, the compiler forces validation before send.","id":"bd-3gtl","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Repl Events must use a canonical/verified frame type","type":"bug"}
{"_at":[1768465837564,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768444543441,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nREALTIME_PLAN §0.19 requires MAX_CHECKPOINT_JOB_QUEUE enforcement (coalesce by group when full). Limits include max_checkpoint_job_queue, but scheduler never consults it.\n\nEvidence:\n- src/core/limits.rs defines max_checkpoint_job_queue.\n- No call sites reference it (rg shows only definitions/tests).\n\n**Acceptance**\n- [ ] Enforce max_checkpoint_job_queue in checkpoint scheduler (per store), coalescing when full.\n- [ ] Add tests verifying queue limit behavior.","id":"bd-3m5.95","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Checkpoint job queue limit is defined but never enforced","type":"bug"}
{"_at":[1768704519285,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768701673166,0],"created_by":"darin@darinsmcstudio2.lan","description":" intermittently fails with missing store_id in span. Failed in cargo test run, passed on re-run. Investigate span propagation / test isolation to make deterministic.","id":"bd-bpo6","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Flaky mutation span test misses store_id (src/daemon/executor.rs:1367)","type":"bug"}
{"_at":[1768819994984,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768778641103,0],"created_by":"darin@darinsmcstudio2.lan","description":"tests/integration/daemon/repl_e2e.rs uses external tailnet_proxy for tailnet/pathological profiles. Consider using in-process NetworkSimulator (test_harness) for most fault-injection coverage, keeping only a minimal tailnet_proxy smoke test to validate the binary + framing.","id":"bd-iv40","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"closed","title":"Replace tailnet_proxy integration tests with network sim where possible","type":"chore"}
