{"_at":[1768622488769,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] StalenessChecker detects when db is behind git store\n- [ ] AllowStale flag available globally\n- [ ] Read-only commands auto-import on stale db\n- [ ] Write commands fail fast on stale db\n- [ ] Clear error messages guide user to sync\n- [ ] Staleness info shows commits ahead and time delta\n- [ ] Auto-import is transparent (debug logging only)\n- [ ] No performance regression on staleness check","created_at":[1768622488769,0],"created_by":"darin@darinsmcstudio2.lan","description":"","design":"Port the stale database handling feature from Go beads to beads-rs.\n\n## Problem\n\nWhen database is stale (git store ref has updates not yet imported), normal commands fail. This breaks read-only workflows where you just want to query current state.\n\n## Go beads solution\n\n`AllowStale` flag that:\n1. Allows read-only commands to proceed with current db state\n2. Auto-imports on stale db for read commands\n3. Fails fast for write commands\n\nStale detection: Compare db last_sync timestamp with git store ref commit time.\n\n## Implementation approach\n\n**Core stale detection** (`src/daemon/staleness.rs`):\n```rust\npub struct StalenessChecker {\n    store_ref: String,  // refs/heads/beads/store\n}\n\nimpl StalenessChecker {\n    /// Check if database is stale compared to git store\n    pub fn is_stale(&self, db: &CanonicalState, repo: &Repository) -> Result<bool> {\n        let store_commit = repo.find_reference(&self.store_ref)?\n            .peel_to_commit()?;\n        let store_time = store_commit.time().seconds();\n        \n        let db_sync_time = db.last_sync_time();\n        \n        Ok(store_time > db_sync_time)\n    }\n    \n    /// Get staleness info for display\n    pub fn staleness_info(&self, db: &CanonicalState, repo: &Repository) -> Result<StalenessInfo> {\n        // commits ahead, time delta, etc.\n    }\n}\n```\n\n**Command context** (`src/daemon/state.rs`):\n```rust\npub struct CommandContext {\n    pub allow_stale: bool,\n    pub readonly: bool,\n}\n\nimpl DaemonState {\n    pub fn check_staleness(&self, ctx: &CommandContext) -> Result<()> {\n        if self.is_stale()? {\n            if ctx.readonly && ctx.allow_stale {\n                // Auto-import for read commands\n                self.import_from_store()?;\n                Ok(())\n            } else if ctx.readonly {\n                warn!(\"Database is stale, proceeding with current state\");\n                Ok(())\n            } else {\n                Err(Error::StaleDatabase)\n            }\n        } else {\n            Ok(())\n        }\n    }\n}\n```\n\n**CLI integration**:\n```rust\n// Global flag\n#[arg(long, global = true)]\nallow_stale: bool,\n\n// Read-only commands automatically use AllowStale\npub const READ_ONLY_COMMANDS: &[&str] = &[\n    \"list\", \"show\", \"ready\", \"blocked\", \"stats\", \n    \"dep-tree\", \"comment-list\"\n];\n```\n\n**Error types** (`src/core/error.rs`):\n```rust\n#[derive(Debug, thiserror::Error)]\npub enum Error {\n    #[error(\"Database is stale. Run 'bd sync' to update, or use --allow-stale\")]\n    StaleDatabase,\n    \n    #[error(\"Cannot perform write operation on stale database\")]\n    WriteOnStale,\n}\n```\n\n## Files to reference\n\nGo implementation:\n- `/Users/darin/Projects/beads-rs-macstudio/tmp/beads/cmd/bd/context.go` (AllowStale field)\n- `/Users/darin/Projects/beads-rs-macstudio/tmp/beads/internal/rpc/protocol.go` (read-only ops)\n\nKey logic:\n```go\n// From context.go\nAllowStale   bool\n\n// Auto-import on stale for read commands\nif cmdCtx.AllowStale && isReadOnly {\n    store.ImportFromGit()\n}\n```\n\n## Design notes\n\n**Staleness detection**:\n- Compare git store ref HEAD time with db metadata\n- Store last sync timestamp in db metadata table\n- Cache staleness check result per command\n\n**Auto-import behavior**:\n- Only for read-only commands\n- Transparent to user (maybe log at debug level)\n- Falls back to current state if import fails\n\n**Write command protection**:\n- NEVER allow writes on stale db\n- Clear error message pointing to `bd sync`\n- Prevents merge conflicts from concurrent edits\n\n**Performance**:\n- Staleness check should be fast (cache git ref lookup)\n- Auto-import only when actually stale\n- Don't block reads unnecessarily\n\n## Questions\n\n1. Should auto-import be opt-in or opt-out for read commands?\n2. How stale is too stale? (warn threshold)\n3. Should `bd sync` be run automatically on stale, or require explicit flag?\n4. Cache staleness check for how long?","id":"bd-ze0x.34","labels":{"cc":{"max":{}},"entries":{"human-needed":[{"counter":8543539697362074134,"replica":"7dec3cad-0b77-499d-5813-2737e4f195dd"}]}},"priority":2,"status":"open","title":"Implement stale database handling - AllowStale mode for read-only commands","type":"feature"}
{"_at":[1768622490745,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768622490745,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`bd list` and `bd search` lack flexible sorting. Go beads doesn't have explicit --sort flags but Rust implementation should add this UX improvement.\n\n**Design**\nAdd sorting flags to `bd list` and `bd search`:\n\n`--sort <field>` options:\n- `priority` (default): P0 → P4\n- `created`: oldest → newest\n- `updated`: least recently updated → most recent\n- `status`: open → in_progress → blocked → closed\n- `id`: lexicographic\n- `title`: alphabetic\n\n`--reverse` flag: reverses sort order\n\nExamples:\n```bash\nbd list --sort updated               # least recent first\nbd list --sort priority --reverse    # P4 → P0\nbd list --sort created --reverse     # newest first\nbd search \"auth\" --sort status\n```\n\n**Design Notes**\n- Default sort: priority ASC (P0 first), then created DESC (newest first)\n- Implement in Rust using `sort_by_key` with custom comparators\n- Status sort order: open < in_progress < blocked < deferred < closed\n- Sorting happens in-memory after database query (simple, flexible)\n- Works with all filters (--status, --priority, --label, etc.)\n\n**Acceptance**\n- [ ] --sort flag with options: priority, created, updated, status, id, title\n- [ ] --reverse flag reverses sort order\n- [ ] Default: priority ASC, created DESC\n- [ ] Status sort uses semantic ordering\n- [ ] Works on bd list and bd search\n- [ ] Combines with existing filters\n- [ ] --help documents sort field options\n\n**Files:**\n- `src/cli/list.rs`\n- `src/cli/search.rs`\n- `src/cli/sorting.rs` (new - shared sort logic)","id":"bd-ze0x.36","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"open","title":"Sorting flags --sort and --reverse for bd list/search","type":"feature"}
