{"_at":[1768858715044,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768856403938,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n\nWAL segments don't rotate when `wal_segment_max_bytes` is exceeded in integration tests, even though the config is written correctly.\n\n**Evidence**\n\nThe `repl_daemon_stress_wal_rotation_roundtrip` test:\n1. Sets `wal_segment_max_bytes = 8192` (8KB) in the config\n2. Creates enough events to exceed 8KB\n3. Expects `segment_count > 1`\n4. Fails with `segment_count = 1` and `total_bytes = 17098` (17KB)\n\nThe config file at `node-0/config/beads-rs/config.toml` clearly shows:\n```toml\n[limits]\nwal_segment_max_bytes = 8192\n```\n\nBut the WAL file grows to 17KB without rotating:\n```\nsegment-1768855941320-d358b60c-1a29-4065-d89d-d98ae85e5e95.wal  17098 bytes\n```\n\n**Debugging performed**\n\n1. Verified config is written correctly to `$XDG_CONFIG_HOME/beads-rs/config.toml`\n2. Verified daemon starts with `XDG_CONFIG_HOME` pointing to the right directory\n3. Confirmed unit test `segment_rotates_on_size` passes - rotation logic itself works\n4. Confirmed config merge tests pass - `merge_layers_respects_precedence` works\n5. Traced config loading path:\n   - `load_or_init()` → `load_for_repo()` → `load_user_config()` → parses as `ConfigLayer`\n   - `merge_layers(user, repo)` applies `LimitsOverride` to `Config::default()`\n   - `apply_env_overrides()` applies `BD_TEST_FAST` overrides (doesn't touch `wal_segment_max_bytes`)\n   - `Daemon::new_with_config()` stores `config.limits`\n   - `StoreRuntime::open()` receives `daemon.limits()`\n   - `EventWal::new()` creates `SegmentConfig::from_limits(limits)`\n\n**Hypothesis**\n\nThe config loading path looks correct, but something is preventing the limits from being applied. Possibilities:\n1. Store is opened before config is fully loaded (unlikely - daemon is created with config)\n2. Serialization/deserialization mismatch between `Config` and `ConfigLayer`\n3. The daemon isn't reading from `XDG_CONFIG_HOME` for some reason\n4. There's a code path that creates the store with default limits\n\n**Affected tests**\n\n- `repl_daemon_stress_wal_rotation_roundtrip` - expects WAL rotation after exceeding 8KB\n- `repl_checkpoint_bootstrap_under_churn` - expects WAL segments to reach 2 after 400 churned requests with 64KB limit\n\n**Files involved**\n\n- `tests/integration/fixtures/repl_rig.rs` - writes config via `write_replication_user_config()`\n- `src/daemon/run.rs:74` - `load_or_init()` loads config\n- `src/config/load.rs` - `load_user_config()` parses as `ConfigLayer`\n- `src/config/merge.rs` - `merge_layers()` applies overrides\n- `src/daemon/wal/segment.rs:388` - `should_rotate()` checks `max_segment_bytes`\n- `src/daemon/store/runtime.rs:185` - `EventWal::new()` created with limits","id":"bd-azss","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"WAL segment rotation ignores wal_segment_max_bytes config in integration tests","type":"bug"}
