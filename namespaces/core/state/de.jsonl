{"_at":[1769516774010,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] External crates cannot implement `OrSetValue` directly.\n- [ ] All existing internal implementations continue to work.\n- [ ] Documentation/comments explain how to add new deterministic value types internally.\n- [ ] CRDT merge determinism is enforced by type boundaries, not conventions.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769495028406,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`OrSetValue` is a public trait that requires a deterministic byte encoding for collision hashing, but nothing in the type system enforces determinism. External implementations can accidentally use non‑deterministic encodings (iteration over HashMap, randomized ordering, etc.), breaking CRDT determinism in subtle ways. This violates the “types should mirror your domain’s actual algebra” and “types tell the truth” principles.\n\nKey references:\n- `crates/beads-core/src/orset.rs:24` — `OrSetValue` is public and unconstrained.\n\nSeverity: non-deterministic merges and inconsistent CRDT state if a consumer implements `OrSetValue` incorrectly.","design":"**Design**\nSeal or constrain `OrSetValue` so only known-deterministic implementations are possible.\n\nOption A (sealed trait):\n- Add a private `sealed` module with a `Sealed` trait.\n- `pub trait OrSetValue: sealed::Sealed + Ord + Clone { ... }`.\n- Implement `Sealed` only for internal types (String, DepKey, Label, etc.) and document how to add new types internally.\n\nOption B (newtype wrapper):\n- Use `Deterministic<T>` wrapper that only exists for vetted types; `OrSetValue` is implemented for `Deterministic<T>` only.\n\nOption C (constructor-enforced bytes):\n- Replace `collision_bytes` with a canonical encoder function supplied at construction of the OR-Set, so determinism is localized.\n\nGiven repo philosophy, Option A is simplest and preserves API safety.","id":"bd-m26t","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Seal OrSetValue to enforce deterministic collision bytes","type":"bug"}
