{"_at":[1768801568268,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768778983197,0],"created_by":"darin@darinsmcstudio2.lan","description":"tests/integration/fixtures/load_gen.rs currently opens a new IPC connection per request. Use IpcConnection (or a small per-worker connection pool) so large loads don't pay connect/handshake each time.","id":"bd-2ybw","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"closed","title":"LoadGenerator use persistent IpcConnection to avoid per-request connect","type":"chore"}
{"_at":[1768416734612,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768413435336,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nThe test suite runtime is dominated by CLI integration tests that repeatedly spawn the `bd` binary, initialize git repos, and auto-start the daemon. `tests/critical_path.rs` alone has 83 tests, each doing multiple `bd` invocations (init/create/show/list/close/etc). `tests/migration.rs` adds 12 more, and `tests/daemon_lifecycle.rs` includes multi-second waits. This produces long wall-clock time and amplifies flakiness when tests run in parallel.\n\nEvidence:\n- `tests/critical_path.rs`: 83 `#[test]` cases, each building temp repos and running the CLI several times.\n- `tests/migration.rs`: 12 integration tests with CLI + git usage.\n- `tests/daemon_lifecycle.rs`: multiple sleeps (up to 5s) while waiting for shutdowns.\n\n**Design**\n- Add a fast default test tier:\n  - Convert the critical-path file into fewer table-driven tests (one daemon + repo per test, multiple assertions per run).\n  - Keep a smaller smoke subset enabled by default; move exhaustive CLI scenarios under `#[ignore]` or `feature = \"slow-tests\"`.\n- Reuse a single daemon+repo fixture per test module to reduce repeated daemon startups.\n- Add a `just test-fast` target for default runs and a `just test-slow` target for full integration coverage.\n- Document the tiers and expected runtime budget.\n\n**Acceptance**\n- [ ] Default `cargo test` runtime is substantially reduced (baseline recorded in bead; target under 2â€“3 min on dev machine).\n- [ ] Full integration coverage remains available behind `--features slow-tests` or `cargo test -- --ignored`.\n- [ ] The CLI critical-path coverage is preserved via table-driven tests or a dedicated slow suite.\n\n**Files:**\n- tests/critical_path.rs\n- tests/migration.rs\n- tests/daemon_lifecycle.rs\n- justfile\n- docs/philosophy/test_design.md (optional)","id":"bd-3m5.80","labels":{"cc":{"max":{}},"entries":{}},"priority":0,"status":"closed","title":"CRITICAL: tests are slow due to heavy CLI integration suite","type":"bug"}
{"_at":[1768516700787,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] No code path can use a verified Record without Seq1 and header/body/hash checks.\n- [ ] Record decode rejects origin_seq=0 early.\n- [ ] WAL replay and WAL range reads use the verified record type.\n- [ ] Tests cover header/body mismatch and seq0 rejection.","assignee":"darin@book","created_at":[1768503784914,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nRecordHeader stores origin_seq as u64 and Record represents both decoded and validated states. Several paths (repl/wal replay/range reads) can use Record without proving origin_seq >= 1 or header/body/hash consistency. There is a validate_header_matches_body helper, but nothing in types forces callers to use it. This is brittle and violates type_design guidance (invariants should be unrepresentable).\n\n**Files:** src/daemon/wal/record.rs, src/daemon/wal/frame.rs, src/daemon/wal/replay.rs, src/daemon/repl/runtime.rs, src/daemon/executor.rs, src/daemon/core.rs","design":"**Design**\n- Split Record into raw vs verified variants (e.g., Record<Unverified> and Record<Verified>).\n- Use Seq1 (or a new nonzero type) in the verified RecordHeader to encode origin_seq >= 1.\n- Provide Record::decode_raw + Record::verify_with_event_body (checks header/body match and sha256(event_body_bytes)).\n- Update replay/range readers to return Verified records; update writers to build Verified records directly.\n- Add targeted tests for seq0 rejection and header/body mismatch errors.","id":"bd-989","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Add typestate for WAL records (Seq1 + verified header/body)","type":"chore"}
{"_at":[1769222444555,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Test/compile guard exists and fails on compilers < 1.64.\\n- [ ] rust-version in Cargo.toml remains >= 1.64 (currently 1.91).","assignee":"darin@book","closed_reason":"Paused per request before starting work","created_at":[1769209801009,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\\nCode uses if-let chains; lowering MSRV below their stabilization would break builds without clear failure mode.\\n\\n**Files**: Cargo.toml, tests/* (new test module)","design":"**Design**\\nAdd a small compile-time guard using rustversion (dev-dependency):\\n- In a test module, add #[rustversion::before(1.64)] compile_error!(\"MSRV must be >= 1.64 for let-chains\").\\nThis makes any MSRV regression fail immediately. Keep Cargo.toml rust-version in sync.","id":"bd-qz97.9","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"closed","title":"MSRV guard: enforce compiler support for let-chains","type":"chore"}
