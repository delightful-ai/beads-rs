{"_at":[1768416734612,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768413435336,1],"darin@book"],"claim":[[1768416346335,1],"darin@book"],"description":[[1768413435336,1],"darin@book"],"design":[[1768413435336,1],"darin@book"],"estimated_minutes":[[1768413435336,1],"darin@book"],"external_ref":[[1768413435336,1],"darin@book"],"labels":[[1768413435336,1],"darin@book"],"priority":[[1768413435336,1],"darin@book"],"source_repo":[[1768413435336,1],"darin@book"],"title":[[1768413435336,1],"darin@book"],"type":[[1768413435336,1],"darin@book"]},"assignee":"darin@book","assignee_at":[1768416346335,1],"assignee_expires":1768419946335,"closed_at":[1768416734612,1],"closed_by":"darin@book","created_at":[1768413435336,1],"created_by":"darin@book","description":"**Problem**\nThe test suite runtime is dominated by CLI integration tests that repeatedly spawn the `bd` binary, initialize git repos, and auto-start the daemon. `tests/critical_path.rs` alone has 83 tests, each doing multiple `bd` invocations (init/create/show/list/close/etc). `tests/migration.rs` adds 12 more, and `tests/daemon_lifecycle.rs` includes multi-second waits. This produces long wall-clock time and amplifies flakiness when tests run in parallel.\n\nEvidence:\n- `tests/critical_path.rs`: 83 `#[test]` cases, each building temp repos and running the CLI several times.\n- `tests/migration.rs`: 12 integration tests with CLI + git usage.\n- `tests/daemon_lifecycle.rs`: multiple sleeps (up to 5s) while waiting for shutdowns.\n\n**Design**\n- Add a fast default test tier:\n  - Convert the critical-path file into fewer table-driven tests (one daemon + repo per test, multiple assertions per run).\n  - Keep a smaller smoke subset enabled by default; move exhaustive CLI scenarios under `#[ignore]` or `feature = \"slow-tests\"`.\n- Reuse a single daemon+repo fixture per test module to reduce repeated daemon startups.\n- Add a `just test-fast` target for default runs and a `just test-slow` target for full integration coverage.\n- Document the tiers and expected runtime budget.\n\n**Acceptance**\n- [ ] Default `cargo test` runtime is substantially reduced (baseline recorded in bead; target under 2â€“3 min on dev machine).\n- [ ] Full integration coverage remains available behind `--features slow-tests` or `cargo test -- --ignored`.\n- [ ] The CLI critical-path coverage is preserved via table-driven tests or a dedicated slow suite.\n\n**Files:**\n- tests/critical_path.rs\n- tests/migration.rs\n- tests/daemon_lifecycle.rs\n- justfile\n- docs/philosophy/test_design.md (optional)","id":"bd-3m5.80","labels":[],"priority":0,"status":"closed","title":"CRITICAL: tests are slow due to heavy CLI integration suite","type":"bug"}
{"_at":[1768516700787,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768503784914,1],"darin@book"],"claim":[[1768514093725,1],"darin@book"],"description":[[1768503784914,1],"darin@book"],"design":[[1768503784914,1],"darin@book"],"estimated_minutes":[[1768503784914,1],"darin@book"],"external_ref":[[1768503784914,1],"darin@book"],"labels":[[1768503784914,1],"darin@book"],"priority":[[1768503784914,1],"darin@book"],"source_repo":[[1768503784914,1],"darin@book"],"title":[[1768503784914,1],"darin@book"],"type":[[1768503784914,1],"darin@book"]},"acceptance_criteria":"- [ ] No code path can use a verified Record without Seq1 and header/body/hash checks.\n- [ ] Record decode rejects origin_seq=0 early.\n- [ ] WAL replay and WAL range reads use the verified record type.\n- [ ] Tests cover header/body mismatch and seq0 rejection.","assignee":"darin@book","assignee_at":[1768514093725,1],"assignee_expires":1768517693725,"closed_at":[1768516700787,1],"closed_by":"darin@book","created_at":[1768503784914,1],"created_by":"darin@book","description":"**Problem**\nRecordHeader stores origin_seq as u64 and Record represents both decoded and validated states. Several paths (repl/wal replay/range reads) can use Record without proving origin_seq >= 1 or header/body/hash consistency. There is a validate_header_matches_body helper, but nothing in types forces callers to use it. This is brittle and violates type_design guidance (invariants should be unrepresentable).\n\n**Files:** src/daemon/wal/record.rs, src/daemon/wal/frame.rs, src/daemon/wal/replay.rs, src/daemon/repl/runtime.rs, src/daemon/executor.rs, src/daemon/core.rs","design":"**Design**\n- Split Record into raw vs verified variants (e.g., Record<Unverified> and Record<Verified>).\n- Use Seq1 (or a new nonzero type) in the verified RecordHeader to encode origin_seq >= 1.\n- Provide Record::decode_raw + Record::verify_with_event_body (checks header/body match and sha256(event_body_bytes)).\n- Update replay/range readers to return Verified records; update writers to build Verified records directly.\n- Add targeted tests for seq0 rejection and header/body mismatch errors.","id":"bd-989","labels":[],"priority":2,"status":"closed","title":"Add typestate for WAL records (Seq1 + verified header/body)","type":"chore"}
