{"_at":[1768289549636,1],"_by":"darin@darinsmacstudio.lan","_v":{"acceptance_criteria":[[1768195835477,1],"darin@darinsmacstudio.lan"],"claim":[[1768288048955,1],"darin@darinsmacstudio.lan"],"description":[[1768177859800,1],"darin@darinsmacstudio.lan"],"design":[[1768177859800,1],"darin@darinsmacstudio.lan"],"estimated_minutes":[[1768177859800,1],"darin@darinsmacstudio.lan"],"external_ref":[[1768177859800,1],"darin@darinsmacstudio.lan"],"labels":[[1768177859800,1],"darin@darinsmacstudio.lan"],"priority":[[1768261541577,1],"darin@darinsmacstudio.lan"],"source_repo":[[1768177859800,1],"darin@darinsmacstudio.lan"],"title":[[1768177859800,1],"darin@darinsmacstudio.lan"],"type":[[1768177859800,1],"darin@darinsmacstudio.lan"]},"acceptance_criteria":"- [ ] All mutation handlers use the events-first pipeline (plan -> WAL append -> apply_event).\n- [ ] Idempotent retry returns prior txn_id/event_ids without writing a new event.\n- [ ] Watermarks advance only after apply_event completes.","assignee":"darin@darinsmacstudio.lan","assignee_at":[1768288048955,1],"assignee_expires":1768291648955,"closed_at":[1768289549636,1],"closed_by":"darin@darinsmacstudio.lan","created_at":[1768177859800,1],"created_by":"darin@darinsmacstudio.lan","description":"**Problem**\nPhase 4: integrate the events first mutation pipeline in the daemon. Current `src/daemon/executor.rs` mutates CanonicalState directly and writes snapshot WAL. We need WAL append plus deterministic apply_event and watermark updates.\n\n**Context**\n- REALTIME_PLAN.md ยง8.3 (apply pipeline) and ยง6.5 (crash consistency ordering)\n- StoreRuntime integration in ยง7.1\n**Files:** src/daemon/executor.rs, src/daemon/core.rs, src/daemon/store_runtime.rs, src/daemon/wal/mod.rs, src/daemon/query.rs","design":"**Design**\n- Replace direct mutation calls with: MutationEngine -> EventWal append -> core::apply_event -> update indexes and watermarks -> schedule replication and checkpoint.\n- Enforce idempotency via WAL index lookup before creating a new event when client_request_id is present.\n- Persist HLC state and idempotency mapping in the same WAL append critical section.\n- Ensure responses are returned only after apply and watermark updates complete.","id":"bd-3m5.13","labels":[],"priority":1,"status":"closed","title":"Phase 4: Daemon events first mutation pipeline","type":"task"}
{"_at":[1768481431340,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768444192878,1],"darin@book"],"claim":[[1768481060212,1],"darin@book"],"description":[[1768444192878,1],"darin@book"],"design":[[1768444192878,1],"darin@book"],"estimated_minutes":[[1768444192878,1],"darin@book"],"external_ref":[[1768444192878,1],"darin@book"],"labels":[[1768444192878,1],"darin@book"],"priority":[[1768444192878,1],"darin@book"],"source_repo":[[1768444192878,1],"darin@book"],"title":[[1768444192878,1],"darin@book"],"type":[[1768444192878,1],"darin@book"]},"assignee":"darin@book","assignee_at":[1768481060212,1],"assignee_expires":1768484660212,"closed_at":[1768481431340,1],"closed_by":"darin@book","created_at":[1768444192878,1],"created_by":"darin@book","description":"**Problem**\nREALTIME_PLAN ยง0.2 recommends updating store.lock last_heartbeat_ms periodically while holding the lock. StoreLock::update_heartbeat exists but is never called, so lock metadata becomes stale immediately.\n\nEvidence:\n- src/daemon/store_lock.rs defines update_heartbeat, but no call sites (rg update_heartbeat).\n\n**Why this violates plan**\nHeartbeat is the intended staleness signal for operators. Without updates, bd store unlock cannot reliably distinguish live vs stale locks.\n\n**Acceptance**\n- [ ] Add periodic heartbeat updates (e.g., in daemon run loop every ~10s).\n- [ ] Heartbeat failures are logged but do not crash daemon.","id":"bd-3m5.87","labels":[],"priority":3,"status":"closed","title":"Store lock heartbeat never updated","type":"bug"}
