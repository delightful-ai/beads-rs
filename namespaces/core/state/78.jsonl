{"_at":[1768247269893,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darinsmacstudio.lan","created_at":[1768180765428,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nPhase 3 implementation must be verified before Phase 4 starts.\n\n**Context**\n- REALTIME_PLAN.md §18: WAL framing/truncation, index rebuild, origin_seq allocation\n- Depends on: Phase 3 implementation + Phase 3 test infrastructure\n\n**Design**\nDeterministic tests for:\n- WAL framing: write records, read back, verify crc32c\n- Tail truncation: partial record at EOF → truncate and recover\n- WAL index rebuild: delete wal.sqlite, rebuild from segments, verify offsets\n- Incremental catch-up: last_indexed_offset -> scan to EOF and index\n- origin_seq allocation: append → seq increments monotonically, no gaps\n\n**Acceptance**\n- [ ] tests/phase3_wal.rs: framing + truncation tests\n- [ ] tests/phase3_index.rs: index rebuild + catch-up tests\n- [ ] tests/phase3_seq.rs: origin_seq allocation tests\n- [ ] cargo test phase3_ passes\n\n**Files:** tests/phase3_wal.rs (new), tests/phase3_index.rs (new), tests/phase3_seq.rs (new)","id":"bd-3m5.58","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 3 tests: WAL framing + index rebuild + origin_seq","type":"task"}
{"_at":[1769518997079,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"**Acceptance**\n- [ ] `VerifiedEvent` exposes `EventBytes<Canonical>` (not Opaque).\n- [ ] Canonical bytes cannot be constructed outside the canonical encoder (`new_unchecked` not public).\n- [ ] `verify_event_frame` rejects non‑canonical encodings and computes hash from canonical bytes.\n- [ ] Downstream code uses canonical bytes without additional validation; explicit raw‑bytes usage is opt‑in.\n- [ ] Tests cover rejection of non‑canonical frames and round‑trip canonical encode/verify.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769495029037,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`VerifiedEvent` stores `EventBytes<Opaque>` even though verification implies canonical encoding. Worse, `EventBytes<Canonical>::new_unchecked` is public, so any caller can lie about canonicality. The compiler cannot enforce that “verified” bytes are actually canonical or that hashes are computed over canonical bytes.\n\nThis violates parse‑don’t‑validate: we parse, verify, *then* throw away canonical information. It also undermines deterministic hashing and replay safety.\n\nKey refs:\n- `crates/beads-core/src/event.rs:52` — `EventBytes<Canonical>::new_unchecked` is public.\n- `crates/beads-core/src/event.rs:180` — `VerifiedEvent` holds `EventBytes<Opaque>`.\n\n**Impact**\nHash/identity ambiguity for WAL/repl. A non‑canonical frame can slip through and still be treated as verified by downstream code.","design":"**Design (opinionated)**\nMake canonical bytes the default for verified events, and make it impossible to forge canonicality.\n\n1) Restrict constructors:\n- Make `EventBytes<Canonical>::new_unchecked` `pub(crate)` (or private) so only the canonical encoder can construct it.\n\n2) Change `VerifiedEvent` to carry canonical bytes:\n- `VerifiedEvent { body, bytes: EventBytes<Canonical>, sha256, prev }`.\n- If raw bytes are needed for transport, carry them explicitly as `raw_bytes: EventBytes<Opaque>` in a separate wire struct, not in the verified core type.\n\n3) Verification should enforce canonical encoding:\n- In `verify_event_frame`, decode body, *re‑encode canonical bytes*, and compare:\n  - If canonical bytes != frame bytes => reject as non‑canonical.\n  - Compute hash from canonical bytes and ensure it matches `sha256`.\n\n4) Make canonicality contagious:\n- Any API that accepts `VerifiedEvent` can now safely assume canonical bytes; no re‑encoding or re‑validation required.\n\nThis turns canonicality into a compile‑time guarantee, not a runtime convention.","id":"bd-91v8","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Make VerifiedEvent carry canonical event bytes","type":"bug"}
{"_at":[1768535261373,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] RepoState has no wal_sequence field.\n- [ ] No references remain in code or tests.","assignee":"darin@book","created_at":[1768503831170,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nRepoState.wal_sequence is never read or written outside struct initialization (src/daemon/repo.rs). It is a legacy snapshot-WAL counter and no longer reflects the realtime event WAL sequencing (per-namespace origin_seq). Keeping it is misleading and dead.\n\n**Files:** src/daemon/repo.rs","design":"**Design**\n- Remove wal_sequence from RepoState and its initializers.\n- Scan for any remaining uses; if any are discovered, either delete or replace with the correct event-WAL sequencing concept.","id":"bd-pkcb","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"closed","title":"Remove dead RepoState.wal_sequence","type":"chore"}
{"_at":[1768622403326,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768622403326,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nbeads-rs needs the formula system - declarative workflow templates that compile to protos. Formulas are the source layer above protos, enabling composition, inheritance, and complex workflow patterns.\n\n**What are Formulas?**\nFormulas are .formula.json/.formula.toml files that define workflows declaratively:\n- Variable definitions with defaults, validation, enums\n- Steps with dependencies (depends_on, needs, waits_for)\n- Composition via extends, aspects, bond points\n- Control flow: loops, branches, gates\n\n**How it Works (Go beads)**\n1. Parser loads formula from search paths (.beads/formulas/, ~/.beads/formulas/)\n2. Resolve inheritance (extends field)\n3. Apply transformations: control flow, aspects, inline expansion\n4. Cook to proto (ephemeral subgraph in memory) OR persist to DB\n5. Pour/wisp instantiates the proto with variable substitution\n\n**Search Paths**\n1. .beads/formulas/ (project)\n2. ~/.beads/formulas/ (user)  \n3. $GT_ROOT/.beads/formulas/ (orchestrator)\n\n**Commands**\n- bd formula list - list available formulas\n- bd formula show <name> - show formula details\n- bd cook <formula> - compile formula to proto (ephemeral by default)\n- bd cook <formula> --persist - save proto to DB\n- bd pour <formula> --var k=v - inline cook + instantiate persistent\n- bd mol wisp <formula> --var k=v - inline cook + instantiate ephemeral\n\n**Design Considerations**\n- Parser in Rust using serde for JSON/TOML\n- Formula struct mirrors Go internal/formula/formula.go\n- Variable substitution using {{var}} syntax\n- Inheritance resolver (extends field)\n- Aspect system (AOP-style advice: before, after, around)\n- Control flow operators (loops, branches, gates)\n\n**Files to Study (Go beads)**\n- cmd/bd/cook.go - formula cooking logic\n- cmd/bd/formula.go - formula commands (list, show)\n- internal/formula/ - parser, resolver, transformations\n- .beads/formulas/beads-release.formula.toml - complex example\n\n**Acceptance**\n- [ ] Formula parser for JSON/TOML\n- [ ] Variable substitution engine\n- [ ] Inheritance resolver (extends)\n- [ ] bd formula list/show commands\n- [ ] bd cook compiles formula to proto\n- [ ] Integration with pour/wisp\n- [ ] Tests for formula compilation\n","id":"bd-ze0x.6","labels":{"cc":{"max":{}},"entries":{"human-needed":[{"counter":17962138994002442544,"replica":"3c64a699-353d-d72d-f04e-9f4f1b86d92b"}]}},"priority":1,"status":"open","title":"Add formula system to beads-rs","type":"epic"}
