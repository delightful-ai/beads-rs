{"_at":[1768338304258,1],"_by":"darin@darinsmacstudio.lan","_v":{"acceptance_criteria":[[1768271728087,1],"darin@darinsmacstudio.lan"],"claim":[[1768337604152,1],"darin@darinsmacstudio.lan"],"description":[[1768271728087,1],"darin@darinsmacstudio.lan"],"design":[[1768271728087,1],"darin@darinsmacstudio.lan"],"estimated_minutes":[[1768271728087,1],"darin@darinsmacstudio.lan"],"external_ref":[[1768271728087,1],"darin@darinsmacstudio.lan"],"labels":[[1768271728087,1],"darin@darinsmacstudio.lan"],"priority":[[1768271728087,1],"darin@darinsmacstudio.lan"],"source_repo":[[1768271728087,1],"darin@darinsmacstudio.lan"],"title":[[1768271728087,1],"darin@darinsmacstudio.lan"],"type":[[1768271728087,1],"darin@darinsmacstudio.lan"]},"assignee":"darin@darinsmacstudio.lan","assignee_at":[1768337604152,1],"assignee_expires":1768341204152,"closed_at":[1768338304258,1],"closed_by":"darin@darinsmacstudio.lan","created_at":[1768271728087,1],"created_by":"darin@darinsmacstudio.lan","description":"**Problem**\nThe realtime code client_request_id_reuse_mismatch exists but cannot be emitted. WAL index upsert overwrites existing (namespace, origin_replica_id, client_request_id) rows, hiding mismatched reuse and mutating history.\n\n**Where**\n- src/core/error.rs: ErrorCode::ClientRequestIdReuseMismatch (defined)\n- src/daemon/ops.rs: OpError lacks a variant\n- src/daemon/wal/index.rs: upsert_client_request uses ON CONFLICT DO UPDATE\n\n**Design**\n- Add OpError variant and IPC mapping for client_request_id_reuse_mismatch with details {namespace, client_request_id, expected_request_sha256, got_request_sha256}.\n- Change index behavior to preserve first-seen mapping; detect mismatch and return explicit error instead of overwriting.\n- Keep idempotent reuse path returning original txn/event ids (no mutation) when request_sha matches.\n\n**Acceptance**\n- Reusing client_request_id with different request_sha256 returns client_request_id_reuse_mismatch (retryable=false).\n- WAL index no longer overwrites request_sha256/txn_id/event_ids on conflict.\n- Matching reuse returns prior ids without mutating history.\n\n**Files**\n- src/daemon/ops.rs\n- src/daemon/wal/index.rs\n- src/core/error.rs","id":"bd-3m5.68","labels":[],"priority":1,"status":"closed","title":"Idempotency: detect client_request_id reuse mismatch","type":"bug"}
