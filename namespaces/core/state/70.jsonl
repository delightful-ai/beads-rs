{"_at":[1769404316046,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] `cargo check -p beads-api` passes (api builds in isolation)\n- [ ] `cargo check -p beads-rs` passes\n- [ ] No query_model.rs exists in daemon\n- [ ] No convert.rs exists in api\n- [ ] `beads_rs::api::QueryResult` still resolves\n- [ ] Daemon constructs beads_api types directly\n- [ ] All tests pass","assignee":"darin@book","created_at":[1769398696082,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`crates/beads-rs/src/api/**` needs to become standalone `beads-api` crate. Currently there's type duplication:\n- `api/` has schema types (Issue, IssueSummary, QueryResult, etc.)\n- `daemon/query_model.rs` has duplicate internal types\n- `api/convert.rs` converts between them\n\n**Decision**: Daemon should use beads-api types directly. Delete duplicates and conversion layer.\n\n**Changes**\n\n1. **Move directory**: `crates/beads-rs/src/api/**` → `crates/beads-api/src/**`\n\n2. **Update imports in moved files**:\n   - `use crate::core::...` → `use beads_core::...`\n\n3. **Delete conversion layer**:\n   - Remove `crates/beads-api/src/convert.rs` (was `api/convert.rs`)\n   - Delete `crates/beads-rs/src/daemon/query_model.rs`\n\n4. **Update beads-rs to re-export**:\n   - Replace `pub mod api;` with `pub use beads_api as api;`\n   - This preserves `beads_rs::api::QueryResult`\n\n5. **Update daemon to use beads-api directly**:\n   - `daemon/query_executor.rs`: change imports from `daemon::query_model::*` to `beads_api::*`\n   - `daemon/admin.rs`: return `beads_api::QueryResult` variants directly\n   - `daemon/core.rs`: use `beads_api::*` types\n   - Use existing constructors like `Issue::from_view(...)`, `IssueSummary::from_view(...)`\n\n6. **Update Cargo.toml**:\n   - `beads-api/Cargo.toml`: depends on `beads-core` and serde\n   - `beads-rs/Cargo.toml`: add `beads-api` dependency\n\n**Key insight**: Keep beads-api as schemas + conversions from core types only (e.g., `impl From<&core::Note> for api::Note`). This avoids orphan rules.\n\n**Files**\n- crates/beads-api/src/** (moved from beads-rs/src/api/**)\n- crates/beads-api/src/convert.rs (delete)\n- crates/beads-rs/src/lib.rs (re-export as api)\n- crates/beads-rs/src/daemon/query_model.rs (delete)\n- crates/beads-rs/src/daemon/query_executor.rs (update imports)\n- crates/beads-rs/src/daemon/admin.rs (update imports)\n- crates/beads-rs/src/daemon/core.rs (update imports)\n- crates/beads-api/Cargo.toml\n- crates/beads-rs/Cargo.toml","id":"bd-14fs.3","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Phase 2: Extract api into beads-api","type":"task"}
{"_at":[1770499794635,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] `just dylint` remains canonical entrypoint\n- [ ] Root workflow docs mention boundary lint gate\n- [ ] Check command examples are current","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1770498231780,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nBoundary policy exists but enforcement is not consistently invoked.","design":"Ensure lint command is easy to run locally and referenced as required pre-merge check.","id":"bd-21eg.6","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Wire boundary lint into just/cargo workflow and CI docs","type":"chore"}
{"_at":[1769572208817,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"Acceptance\n- import_checkpoint and import_checkpoint_export reject unsupported checkpoint_format_version with a clear error.\n- All call sites consume a supported/validated meta type (compile-time enforcement).\n- Tests cover: unsupported version, mismatched meta/manifest namespaces, and valid v1 import.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769563863691,0],"created_by":"darin@darinsmcstudio2.lan","description":"Problem\n- CheckpointMeta.checkpoint_format_version is parsed but never validated in import_checkpoint or read_checkpoint_export_at_oid.\n- We can deserialize a future/incompatible format and then attempt to parse it as v1, producing undefined state.\n- The invariant \"only known checkpoint formats may be imported\" is implicit and unchecked.\n\nImpact\n- Silent mis-parse or partial state on format upgrades.\n- Compiler can't help because version compatibility is not encoded in types.\n","design":"Design\n- Introduce a CheckpointFormatVersion enum (currently only V1) and a ParsedCheckpointMeta wrapper that is guaranteed to be supported.\n- Provide a single parse entry point (e.g., CheckpointMeta::parse_supported(bytes) or CheckpointExport::try_from_blobs) that validates:\n  - checkpoint_format_version is supported.\n  - manifest_hash/content_hash match canonical encodings.\n  - meta/manifest namespace lists are normalized and equal (fail otherwise).\n- import_checkpoint / import_checkpoint_export should only accept ParsedCheckpointMeta + ParsedCheckpointManifest, so version gating is enforced by the type system.\n\nScatter fit\n- Centralize all version+hash checks at parse boundary; downstream code should see only validated types.\n\nFiles\n- crates/beads-rs/src/git/checkpoint/meta.rs\n- crates/beads-rs/src/git/checkpoint/manifest.rs\n- crates/beads-rs/src/git/checkpoint/import.rs\n- crates/beads-rs/src/git/checkpoint/publish.rs\n- crates/beads-rs/src/git/checkpoint/cache.rs","id":"bd-5lag","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"checkpoint import must reject unsupported format versions","type":"bug"}
{"_at":[1768522307802,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Replication ingest applies each event at most once to real state.\n- [ ] No full-state clone is performed in the hot replication path.\n- [ ] Apply failures after WAL append are surfaced as corruption with actionable details.\n- [ ] Tests updated to match the new behavior.","assignee":"darin@book","created_at":[1768503824837,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nDaemon::ingest_remote_batch clones namespace state (get_or_default) and applies the entire batch to preview_state before WAL append, then applies again after WAL append. This is O(state size) per batch, doubles apply cost, and introduces another place for divergence if apply semantics change.\n\n**Files:** src/daemon/core.rs, src/core/apply.rs, src/daemon/repl/session.rs","design":"**Design**\n- Remove the preview_state clone/apply pass.\n- Rely on prior validation (verify_event_frame + deterministic apply_event) to make apply failures exceptional; if apply fails post-append, treat as corruption and surface a clear ErrorPayload (and potentially enter maintenance mode).\n- If a preflight is still desired, replace it with a lightweight validation pass that does not clone the full state (e.g., validate_event_body_limits + dependency existence checks already enforced upstream).\n- Update tests that currently rely on preview-state behavior.","id":"bd-d98g","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Remove double-apply in replication ingest","type":"chore"}
