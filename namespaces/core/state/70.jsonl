{"_at":[1768522307802,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768503824837,1],"darin@book"],"claim":[[1768522048464,1],"darin@book"],"description":[[1768503824837,1],"darin@book"],"design":[[1768503824837,1],"darin@book"],"estimated_minutes":[[1768503824837,1],"darin@book"],"external_ref":[[1768503824837,1],"darin@book"],"labels":[[1768503824837,1],"darin@book"],"priority":[[1768503824837,1],"darin@book"],"source_repo":[[1768503824837,1],"darin@book"],"title":[[1768503824837,1],"darin@book"],"type":[[1768503824837,1],"darin@book"]},"acceptance_criteria":"- [ ] Replication ingest applies each event at most once to real state.\n- [ ] No full-state clone is performed in the hot replication path.\n- [ ] Apply failures after WAL append are surfaced as corruption with actionable details.\n- [ ] Tests updated to match the new behavior.","assignee":"darin@book","assignee_at":[1768522048464,1],"assignee_expires":1768525648464,"closed_at":[1768522307802,1],"closed_by":"darin@book","created_at":[1768503824837,1],"created_by":"darin@book","description":"**Problem**\nDaemon::ingest_remote_batch clones namespace state (get_or_default) and applies the entire batch to preview_state before WAL append, then applies again after WAL append. This is O(state size) per batch, doubles apply cost, and introduces another place for divergence if apply semantics change.\n\n**Files:** src/daemon/core.rs, src/core/apply.rs, src/daemon/repl/session.rs","design":"**Design**\n- Remove the preview_state clone/apply pass.\n- Rely on prior validation (verify_event_frame + deterministic apply_event) to make apply failures exceptional; if apply fails post-append, treat as corruption and surface a clear ErrorPayload (and potentially enter maintenance mode).\n- If a preflight is still desired, replace it with a lightweight validation pass that does not clone the full state (e.g., validate_event_body_limits + dependency existence checks already enforced upstream).\n- Update tests that currently rely on preview-state behavior.","id":"bd-d98g","labels":[],"priority":2,"status":"closed","title":"Remove double-apply in replication ingest","type":"chore"}
