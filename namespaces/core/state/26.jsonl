{"_at":[1768448823313,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768444195661,1],"darin@book"],"claim":[[1768444195661,1],"darin@book"],"description":[[1768444195661,1],"darin@book"],"design":[[1768444195661,1],"darin@book"],"estimated_minutes":[[1768444195661,1],"darin@book"],"external_ref":[[1768444195661,1],"darin@book"],"labels":[[1768444195661,1],"darin@book"],"priority":[[1768444195661,1],"darin@book"],"source_repo":[[1768444195661,1],"darin@book"],"title":[[1768444195661,1],"darin@book"],"type":[[1768444195661,1],"darin@book"]},"acceptance_criteria":"- [ ] Segment writers are reused across multiple events (not one segment per mutation).\n- [ ] A single EventWal append API owns the write + fsync + index sequencing invariant.\n- [ ] Executor and replication ingest no longer manually open SegmentWriter directly.","closed_at":[1768448823313,1],"closed_by":"darin@book","closed_reason":"duplicate of bd-3m5.82","created_at":[1768444195661,1],"created_by":"darin@book","description":"**Problem**\nEvery mutation opens a fresh `SegmentWriter` and creates a new WAL segment, so we effectively write one segment per event. There is no `EventWal` type that owns per‑namespace writers and enforces the append/index/fsync ordering invariant; instead, the executor and core manually sequence these steps.\n\n**Signals / Evidence**\n- `apply_mutation_request_inner` creates a new `SegmentWriter::open` for every mutation (`src/daemon/executor.rs`).\n- `ingest_remote_batch` also opens a new `SegmentWriter` per batch (`src/daemon/core.rs`).\n- `wal/mod.rs` exposes low‑level pieces but no high‑level append API; the invariants live in call sites.\n\n**Why this hurts velocity**\nWe keep duplicating WAL/index sequencing logic, and segment rotation logic never gets a chance to do its job. Any change to WAL invariants requires editing multiple call sites and is easy to get subtly wrong.","design":"**Design**\n- Introduce an `EventWal` (or `WalAppender`) struct in `src/daemon/wal` that owns per‑namespace active `SegmentWriter`s.\n- Provide append APIs that encapsulate: (1) allocate seq, (2) write record, (3) fsync, (4) index updates, (5) watermark updates.\n- Keep a per‑namespace writer in `StoreRuntime` (or in EventWal) so segments are reused and rotation is meaningful.\n- Update mutation and replication ingest to go through this API.\n\n**Design Notes**\nThis aligns with the plan’s “EventWal::append” responsibility and moves invariants into one type instead of scattered call sites.","id":"bd-l5k","labels":[],"priority":2,"status":"closed","title":"Introduce EventWal append API + reuse segment writers","type":"task"}
