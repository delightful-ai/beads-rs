{"_at":[1768425704016,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768422496489,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nTests currently serialize via a global env lock because fixtures set process-wide env (BD_DATA_DIR/XDG_RUNTIME_DIR/BD_WAL_DIR). This blocks parallel execution and is fragile.\n\n**Design**\n- Avoid global env mutation in tests.\n- For CLI integration tests, set env only on the Command (already done in some fixtures).\n- For in-process IPC helpers (e.g., fixtures/load_gen using send_request), introduce explicit runtime/socket overrides instead of global env:\n  - Add test-only overrides in daemon::ipc for socket dir (similar to paths::set_data_dir_for_tests), or new send_request_* APIs that accept a socket path/runtime dir.\n  - Update fixtures to pass runtime_dir/socket path explicitly and remove std::env::set_var usage.\n- Remove env locks once overrides are in place.\n\n**Acceptance**\n- [ ] No test fixture calls std::env::set_var for BD_* or XDG_RUNTIME_DIR.\n- [ ] Realtime/load_gen/IPC fixtures accept explicit runtime/socket paths.\n- [ ] Tests run with --test-threads=8 without env-related flakiness.\n\n**Files**\n- tests/fixtures/realtime.rs\n- tests/fixtures/store_dir.rs\n- tests/fixtures/load_gen.rs\n- src/daemon/ipc.rs (test overrides or explicit socket path APIs)\n- src/paths.rs (if adding runtime dir override)\n","id":"bd-5un","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Tests: remove global env locks by avoiding env mutation","type":"bug"}
{"_at":[1769505294393,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"**Acceptance**\n- [ ] `apply_event` only accepts a validated event type; raw `EventBody` cannot compile at call sites.\n- [ ] `apply_bead_upsert`/dep operations require validated patch/op wrappers, not raw wire structs.\n- [ ] There is exactly one public validation boundary from wire bytes to validated events; raw decode types do not escape the module.\n- [ ] All existing callers are migrated; no `validate_event_body_*` calls remain outside the boundary.\n- [ ] Tests: at least one compile‑fail or trybuild test demonstrating that invalid patches cannot reach core apply; runtime tests still reject invalid events at the boundary.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769483948024,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nCore mutation accepts raw wire/event types that can represent invalid states. `apply_event` takes `EventBody` (raw) and `TxnOpV1`/`WireBeadPatch` without a validated type boundary. We rely on runtime validators (`validate_event_body_semantics`, `workflow_patch_from_wire`, `claim_patch_from_wire`, partial checks in `apply_event`) and on call sites remembering to run them. That is a compiler blind spot: a new ingestion path, refactor, or test helper can bypass validation and still mutate CanonicalState.\n\nExamples of illegal states that compile today:\n- `WireBeadPatch`: `status=Closed` with `closed_reason=Keep` or `closed_on_branch=Keep`.\n- Claim patch where `assignee`/`assignee_expires` are mismatched or partially set.\n- `created_at` set without `created_by` (or vice versa).\n- Self-dependencies in `DepAdd`/`DepRemove`.\n- Tombstone lineage fields partially set or invalid.\n\nThis violates “types should tell the truth” and “parse, don’t validate”. Invalid states are representable *after* parsing and can flow into core logic.\n\nKey refs:\n- `crates/beads-core/src/apply.rs:51` — `apply_event` accepts raw `EventBody`.\n- `crates/beads-core/src/event.rs:2353` — runtime semantic validation.\n- `crates/beads-core/src/event.rs:2418` — `ValidatedBeadPatch` exists but isn’t the boundary.\n\n**Impact**\nDeterministic corruption of canonical state from unvalidated events. This is a P0 correctness risk because it weakens the CRDT safety boundary and makes refactors dangerous.","design":"**Design (opinionated)**\nMake validation a *type boundary*, not a convention.\n\n1) Split raw vs validated types:\n- Rename current `EventBody` to `EventBodyRaw` (private to module) or wrap it in `EventBody<Unvalidated>`.\n- Define `EventBody<Validated>` (or `ValidatedEventBody`) that is the only type accepted by core apply.\n- Mirror this for `TxnDelta` and `TxnOpV1` if needed, or wrap `TxnDeltaV1` inside a validated event type.\n\n2) Make validation constructors explicit:\n- `impl TryFrom<EventBodyRaw> for EventBody<Validated>` runs *all* semantic + limits validation.\n- `ValidatedBeadPatch` should be the only patch type that reaches `apply_bead_upsert`.\n- Add `ValidatedDepAdd`, `ValidatedDepRemove`, `ValidatedTombstone` wrappers if needed to encode per-op invariants.\n\n3) Narrow core API surface:\n- Change `apply_event(state, body)` to accept only `EventBody<Validated>`.\n- Make `apply_bead_upsert` accept `ValidatedBeadPatch` (not `WireBeadPatch`).\n- Provide a single validation boundary in ingestion, e.g. `verify_event_frame` returns `VerifiedEvent<Validated>`.\n\n4) Parse-don’t-validate rule:\n- Public decode APIs should return validated types or error (no raw types escaping).\n- Raw/unchecked constructors are `pub(crate)` or private.\n\n5) Migration plan:\n- Add new types and conversions, then update all call sites.\n- Temporarily keep deprecated wrappers that call validation; remove them once all callers are migrated.\n\nThis makes “forgetting to validate” a compile error.","id":"bd-p72a","labels":{"cc":{"max":{}},"entries":{}},"priority":0,"status":"closed","title":"Encode event/patch invariants in types (validated EventBody/TxnDelta)","type":"bug"}
{"_at":[1769221788626,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1769221346002,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\\nREALTIME_PLAN.md says note-id collisions with different content are corruption (not LWW), but CRDT_OVERHAUL.md and current code resolve note collisions deterministically. This spec mismatch can confuse future changes and tests.\\n\\n**Design**\\nPick the authoritative policy and align docs/tests accordingly:\\n- If corruption: update validation/apply to reject note-id collisions and adjust tests.\\n- If deterministic: update REALTIME_PLAN.md wording to match CRDT_OVERHAUL.md and keep tests.\\n\\n**Acceptance**\\n- [ ] Spec text is consistent across REALTIME_PLAN.md and CRDT_OVERHAUL.md.\\n- [ ] Tests match the chosen policy.\\n\\n**Files**\\n- REALTIME_PLAN.md\\n- CRDT_OVERHAUL.md\\n- docs/CRDT_AUDIT.md (if referenced)","id":"bd-qz97.24","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Resolve note collision policy mismatch (REALTIME_PLAN vs CRDT_OVERHAUL)","type":"chore"}
