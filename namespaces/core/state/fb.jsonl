{"_at":[1768917049922,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Apply total for note/label/dep ops\n- [ ] Collisions deterministic (no ApplyError)\n- [ ] Dep indexes updated from OR-Set membership\n\n**Invariants to re-verify**\n- [ ] Apply never errors for missing beads on label/dep/note\n- [ ] Collision resolution deterministic and convergent\n- [ ] Store stamps update only on real membership change","assignee":"darin@book","created_at":[1768894652020,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nApply currently errors on missing beads and collisions; deps are LWW.\n\n**Files**\n- src/core/apply.rs\n- src/core/state.rs\n- src/core/composite.rs","design":"Implement apply handlers for LabelAdd/LabelRemove and DepAdd/DepRemove. Update note handling to store in NoteStore without MissingBead errors. Replace collision errors with deterministic resolution (note_winner + bead collision policy). Update ApplyOutcome as needed for labels/notes.","id":"bd-3zoj.7","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Apply: OR-Set ops, orphans, deterministic collisions","type":"task"}
{"_at":[1768632611383,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"**Acceptance**\n- [ ] New fixture `ReplRig` can spin up N real daemons with isolated dirs under `./tmp`.\n- [ ] Rig can apply ops (create/show) and assert convergence via admin watermarks/heads.\n- [ ] Rig supports tailnet-style fault injection via proxies (delay/drop/dup/reorder).\n- [ ] New slow integration test uses the rig and passes locally.\n- [ ] Cleanup reliably shuts down daemons and proxy processes; no orphaned sockets.\n- [ ] Tests run without writing outside `./tmp`.","assignee":"darin@book","created_at":[1768616041734,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nWe have an in-process `ReplicationRig` and a single ad-hoc daemon-to-daemon test, but no reusable harness to spin up N real daemons with consistent config, fault injection, and convergence assertions. This makes it hard to add end-to-end replication tests that exercise real sockets, IPC, store discovery, and cleanup. Tests also end up duplicating setup/teardown logic and are brittle.\n\nWe need a multi-process replication rig that:\n- Boots N real `bd` daemons in separate repos/data/runtime/config roots under `./tmp`.\n- Wires real replication connections (TCP) with optional tailnet-style fault injection.\n- Provides helpers to apply ops, poll state, and assert convergence on watermarks/heads.\n- Cleans up all daemons and proxy processes reliably.\n\n**Files:** new fixture module (tests/integration/fixtures/repl_rig.rs), updated integration tests under tests/integration/daemon/.","design":"**Design**\n- Create `tests/integration/fixtures/repl_rig.rs` with:\n  - `ReplRig::new(node_count, options)` -> builds per-node dirs in `./tmp`, sets `BD_STORE_ID`, `BD_DATA_DIR`, `XDG_RUNTIME_DIR`, `XDG_CONFIG_HOME`, `BD_NO_AUTO_UPGRADE`.\n  - `Node` helper with `bd_cmd()`, `init()`, `start_daemon()`, `shutdown()`; stores `repo_dir`, `runtime_dir`, `data_dir`, `config_dir`, `listen_addr`, `replica_id`.\n  - `bootstrap_replica()` that runs `bd init`, reads `meta.json` for replica_id (StoreMeta), then shuts down daemon before configuring peers.\n  - `write_replication_config()` to emit `beads.toml` with listen addr + peers + allowed namespaces.\n- Fault injection:\n  - Allow `ReplRig` to optionally insert a `TailnetProxy` per link (reusing `tailnet_proxy` binary) with a profile (tailnet/none or custom). Expose `options.fault_profile` and `options.seed`.\n- Provide helpers:\n  - `create_issue(node, title)` returning id\n  - `wait_for_show(node, id, timeout)`\n  - `admin_status(node)` returning JSON payload\n  - `assert_converged(namespaces)` using admin watermarks/heads across all nodes.\n- Add at least one slow integration test (e.g. 3-node tailnet profile) using the rig instead of custom wiring.\n\n**Files:** tests/integration/fixtures/repl_rig.rs, tests/integration/daemon/* (new test), tests/integration/fixtures/mod.rs","id":"bd-drtn","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Multi-process replication rig helper (real daemons + fault injection)","type":"feature"}
