{"_at":[1769581825097,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Construction of a frame with seq=1 and prev set (or seq>1 without prev) is impossible without a fallible conversion.\n- [ ] `verify_event_frame` takes typed frame and no longer does prev/seq validation internally.\n- [ ] Existing framing sources updated to use constructors; tests updated accordingly.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769494178400,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`EventFrameV1` allows impossible combinations of `origin_seq` and `prev_sha256` (e.g., seq=1 with prev set), and these are rejected only at runtime in `verify_event_frame`. This is a structural invariant that should be expressed in the type system so callers can’t construct invalid frames.\n\nKey references:\n- `crates/beads-core/src/event.rs:2500` — runtime prev/seq checks in `verify_event_frame`.\n- `crates/beads-core/src/event.rs:150` — `EventFrameV1` definition.\n\nSeverity: low‑level framing invariants are enforced only by convention; easy to break when creating new frame sources.","design":"**Design**\nAdd typestated frame variants to encode the prev/seq relation.\n\nOption A (sum types):\n- `enum EventFrame { Genesis(GenesisFrame), WithPrev(NonGenesisFrame) }`.\n- `GenesisFrame` has `origin_seq = Seq1::from_u64(1)` and `prev_sha256 = None`.\n- `NonGenesisFrame` carries `origin_seq > 1` and `prev_sha256 = Some`.\n\nOption B (phantom state):\n- `EventFrameV1<HasPrev>` with `HasPrev = PrevRequired | PrevForbidden` and constructors enforcing seq rules.\n\nMigration:\n- Keep wire parsing into raw struct, then convert into typed frame with a fallible conversion.\n- Update `verify_event_frame` to accept only typed frame; runtime prev/seq checks become unreachable.","id":"bd-34px","labels":{"cc":{"max":{}},"entries":{}},"notes":[{"at":[1769580773613,0],"author":"darin@darins-Mac-Studio-2.local","content":"Rendering should remain in command files; avoid extracting rendering into shared helpers.","id":"go-comment-bd-34px-1"},{"at":[1769581825097,0],"author":"darin@darinsmcstudio2.lan","content":"Rendering should remain in command files; avoid extracting rendering into shared helpers.","id":"legacy-notes"}],"priority":2,"status":"closed","title":"Encode EventFrame prev/seq invariants in types","type":"bug"}
{"_at":[1768373474494,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Snapshot captures included watermarks and shard contents from a single coordinator tick.\n- [ ] Snapshot object is immutable once created and safe to pass to worker thread.\n- [ ] Export worker consumes only snapshot data (no live reads during I/O).\n- [ ] Snapshot includes metadata needed for manifest/meta construction without touching live state.","assignee":"darin@book","created_at":[1768178745980,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nCheckpoint export requires a snapshot barrier that freezes the state and included watermarks together. Without a typed barrier, the coordinator can accidentally mix shards from different logical times or claim watermarks that aren’t represented in the exported content.\n\n**Context**\n- REALTIME_PLAN.md §13.8 (checkpoint snapshot barrier and consistency rule)\n- Checkpoint scheduling in §13.7 and export workflow in §13.8\n\n**Files:** src/git/checkpoint/types.rs (new), src/git/checkpoint/export.rs, src/daemon/store_runtime.rs","design":"**Design**\n- Introduce an immutable CheckpointSnapshot struct: { group_id, policy_hash, roster_hash, included_watermarks (durable), included_heads?, shard_payloads/dirty_shards, created_at_ms }.\n- The coordinator thread captures the snapshot under a single lock so shard contents and watermarks correspond to the same logical point in time.\n- Make the snapshot owned/immutable (e.g., Arc or owned values), so the worker thread cannot observe concurrent mutations.\n- Enforce a check: included_watermarks must not exceed the max seq represented by shard_payloads; if it would, delay snapshot or recompute.","id":"bd-3m5.30","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 6: CheckpointSnapshot barrier type","type":"task"}
