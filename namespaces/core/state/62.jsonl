{"_at":[1768390806609,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768178783264,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nOperators need introspection into store health, watermarks, segments, replication, and checkpoints.\n\n**Context**\n- REALTIME_PLAN.md §16.1 (admin.status, admin.metrics)\n\n**Design**\n- admin.status returns: store_id, replica_id, namespaces, applied/durable watermarks, WAL segment stats (count/bytes), index health (last_indexed_offset per segment), replication sessions (peers, last_ack, lag), checkpoint groups (dirty/in-flight/last push)\n- admin.metrics returns: counters (wal_append_ok/err, apply_ok/err, repl_events_in/out), gauges (IPC inflight, repl queue depth, per-peer lag), histograms (wal_append_duration, checkpoint_duration)\n- Both return structured JSON\n\n**Acceptance**\n- [ ] admin.status returns complete store introspection\n- [ ] admin.metrics returns counters/gauges/histograms\n- [ ] CLI `bd admin status` and `bd admin metrics` work\n- [ ] Tests verify expected fields\n\n**Files:** src/daemon/ipc.rs, src/daemon/admin.rs (new), src/cli/commands/admin.rs (new)","id":"bd-3m5.31","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 7: admin.status + admin.metrics IPC ops","type":"task"}
{"_at":[1770614068426,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1770611167962,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nGraph/metadata command families are still split across legacy `beads-rs` handlers (`comments`, `dep`, `label`, `epic`, `deleted`, `subscribe`), which blocks a clean ownership boundary for CLI behavior.\n\n**Design**\nPort these command handlers into `crates/beads-cli/src/commands/` in one tranche focused on behavior parity and shared render/helper reuse. Leave explicit shims in `beads-rs` until the full epic closes.\n\n**Acceptance**\n- [ ] `comments`, `dep`, `label`, `epic`, `deleted`, and `subscribe` handlers are owned by `beads-cli`.\n- [ ] Legacy handlers in `beads-rs` are reduced to call-through shims.\n- [ ] Subcommand name mapping and aliases remain stable.\n- [ ] Regression tests cover dep tree/cycles, comment add/list, label add/rm/list, epic status, and deleted/subscription flows.\n- [ ] Full verification gate passes (`fmt`, `dylint`, `clippy`, `test`, `slow-tests`).\n\n**Files**\n- crates/beads-cli/src/commands/comments.rs\n- crates/beads-cli/src/commands/dep.rs\n- crates/beads-cli/src/commands/label.rs\n- crates/beads-cli/src/commands/epic.rs\n- crates/beads-cli/src/commands/deleted.rs\n- crates/beads-cli/src/commands/subscribe.rs\n- crates/beads-rs/src/cli/commands/{comments,dep,label,epic,deleted,subscribe}.rs","id":"bd-atsg.2","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Migrate comments/dep/label/epic/deleted/subscribe handlers to beads-cli","type":"chore"}
{"_at":[1768816715171,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768774749470,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nIPC request handling has no per-request span, so errors and downstream logs (handle_request, read gates, durability waits) lack request context (repo, request type, namespace, actor, client_request_id).\n\n**Design**\n- Add a small RequestContext extractor in `src/daemon/server.rs` that derives request_type + key fields.\n- Create a `tracing::info_span!(\"ipc_request\", ...)` in `process_request_message` and execute `daemon.handle_request` + follow-on handling inside it.\n- For durability waiters, carry the span so the eventual response/logs are in the same span.\n- Keep fields low‑cardinality (request_type, repo, namespace, actor_id, client_request_id, read_consistency).\n\n**Acceptance**\n- [ ] Request handling logs include an `ipc_request` span with the fields above.\n- [ ] Durability wait responses/logs are emitted within the same span.\n- [ ] Unit test (or focused helper test) verifies RequestContext extraction for at least Create + Show.\n\n**Files:** src/daemon/server.rs, src/daemon/ipc/types.rs (if helper added), src/daemon/executor.rs (if needed)","id":"bd-hljv","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Observability: per-IPC request span with request metadata","type":"chore"}
{"_at":[1769542804718,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Internal repl message types cannot be constructed without valid head/seq combinations.\n- [ ] Decode rejects `seq>0` without head and `seq=0` with head (clear error).\n- [ ] Encoding preserves canonical ordering and wire compatibility.\n- [ ] Tests cover valid/invalid ACKs and HELLO/WELCOME watermark snapshots.\n- [ ] `cargo test` passes.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769502740691,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nReplication wire structs (`Ack`, `Hello`, `Welcome`) carry `WatermarkMap` plus optional `WatermarkHeads`. There is no type-level coupling between `seq` and `head`, so it is easy to construct invalid states (e.g., `seq>0` with no head). The compiler cannot prevent this; errors only surface later as runtime failures (`MissingHead` / divergence), and these failures are not localized to the parsing boundary.\n\nThis violates parse-don’t-validate and makes correctness depend on call-site discipline.\n\n**Impact**\n- Incorrect or missing heads can stall replication or mark peers diverged.\n- Internal code can accidentally emit invalid ACKs without compile-time feedback.\n\n**Files**\n- `crates/beads-rs/src/daemon/repl/proto.rs` (Ack/Hello/Welcome decode)\n- `crates/beads-rs/src/daemon/repl/session.rs` (watermark snapshot/seed)\n- `crates/beads-rs/src/daemon/repl/peer_acks.rs`","design":"**Design**\nIntroduce a typed, invariant-preserving watermark representation at the Repl boundary:\n\n- Create an internal type that represents *validated* watermarks (use `Watermarks<K>` or a new `WatermarkSnapshot<K>` that contains `Watermark<K>` values).\n- Keep wire format unchanged by introducing wire-only structs:\n  - `WireAck` / `WireHello` / `WireWelcome` with `WatermarkMap` + `WatermarkHeads` (serde/cbor only)\n  - `Ack` / `Hello` / `Welcome` used internally with `Watermarks<K>` (or validated snapshot type)\n- `decode_*` should parse into wire structs, then immediately validate/convert into the typed representation:\n  - Missing head for seq>0 becomes a `ProtoDecodeError::InvalidField`.\n  - Genesis (`seq=0`) must have no head (or Genesis marker), enforced by `Watermark::new`.\n- `encode_*` should accept the typed representation and derive wire maps/heads in canonical order.\n\n**Ordering / invariants preserved**\n- Maintain deterministic ordering by using `BTreeMap` during wire conversion.\n- No change to wire encoding order or shape; only validation is moved to the parse boundary.","id":"bd-umt1","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Repl watermark heads must be coupled to seq at parse boundary","type":"bug"}
