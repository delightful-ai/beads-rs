{"_at":[1769557397074,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Outbound sessions negotiated with `live_stream_enabled=false` never subscribe to live events or send hot-cache.\n- [ ] `send_events`/`send_hot_cache` are not callable for snapshot-only sessions at compile time.\n- [ ] Inbound path continues to gate live stream and remains consistent with outbound.\n- [ ] Tests cover both negotiation paths (live vs snapshot) and assert no live events sent in snapshot mode.\n- [ ] `cargo test` passes.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769554089930,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nOutbound replication ignores `peer.live_stream_enabled`. After handshake, we always subscribe to the broadcaster and send live events + hot-cache, even when the negotiated capability is false. This violates the wire contract and makes correctness depend on peer tolerance.\n\nThis is a classic invariant that the type system should encode: once a session is negotiated as snapshot-only, the compiler should make it impossible to call live-stream send paths.\n\n**Impact**\n- Protocol mismatch: peers that donâ€™t support live streaming still receive live Events frames.\n- Hard-to-test correctness risk; a refactor can silently reintroduce this since nothing is type-gated.\n\n**Files**\n- `crates/beads-rs/src/daemon/repl/manager.rs` (outbound loop)\n- `crates/beads-rs/src/daemon/repl/session.rs` (handshake negotiation)\n- `crates/beads-rs/src/daemon/repl/server.rs` (inbound already gates; keep consistent)\n","design":"**Design (opinionated)**\nEncode live-stream capability in the session typestate so the compiler prevents misuse.\n\n1) Split streaming phase into two typestates (or a generic):\n```rust\nstruct StreamingLive { peer: SessionPeer }\nstruct StreamingSnapshot { peer: SessionPeer }\n// or Session<Streaming<Live>> vs Session<Streaming<SnapshotOnly>>\n```\n2) Handshake transition chooses the correct type based on `live_stream_enabled`.\n- If `live_stream_enabled == true`, transition to `StreamingLive`.\n- Else transition to `StreamingSnapshot`.\n\n3) Only expose live-stream send helpers for `StreamingLive`:\n- `send_events`, `send_hot_cache`, event subscription setup all require `&Session<*, StreamingLive>`.\n- `StreamingSnapshot` still supports `Want` handling.\n\n4) Outbound loop must respect typestate:\n- Do not create broadcaster subscription unless session is `StreamingLive`.\n- No pending-event draining/hot-cache send in snapshot-only mode.\n\n**Ordering / invariants preserved**\n- Live-stream mode preserves existing ordering semantics (round-robin/wal ordering unchanged).\n- Snapshot-only mode only sends WANT responses; ordering is still canonical via WAL/Want logic.","id":"bd-45vd","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Outbound repl must enforce live_stream_enabled via typestate","type":"bug"}
{"_at":[1768427152531,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768426480808,0],"created_by":"darin@darinsmcstudio2.lan","description":"During sync retry tests, push_update_reference returns 'failed to lock file' which is currently treated as PushRejected instead of NonFastForward. Treat lockfile failures as retryable so sync_with_retry can retry.","id":"bd-m5r","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Sync push lockfile errors should be retryable","type":"bug"}
