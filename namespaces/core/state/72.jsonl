{"_at":[1768512153800,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768503815996,1],"darin@book"],"claim":[[1768510174729,1],"darin@book"],"description":[[1768503815996,1],"darin@book"],"design":[[1768503815996,1],"darin@book"],"estimated_minutes":[[1768503815996,1],"darin@book"],"external_ref":[[1768503815996,1],"darin@book"],"labels":[[1768503815996,1],"darin@book"],"priority":[[1768503815996,1],"darin@book"],"source_repo":[[1768503815996,1],"darin@book"],"title":[[1768503815996,1],"darin@book"],"type":[[1768503815996,1],"darin@book"]},"acceptance_criteria":"- [ ] It is impossible to represent seq>0 with unknown head in the durable/applied watermarks used for contiguity.\n- [ ] Gap buffer/drain paths no longer need PrevUnknown runtime checks for durable head.\n- [ ] Tests cover head-known enforcement and any compatibility behavior.","assignee":"darin@book","assignee_at":[1768510174729,1],"assignee_expires":1768513774729,"closed_at":[1768512153800,1],"closed_by":"darin@book","created_at":[1768503815996,1],"created_by":"darin@book","description":"**Problem**\nWatermark allows HeadStatus::Unknown for seq>0 (core/watermark.rs). Plan ยง0.12 says head sha must be known for seq>0. Today this invariant is enforced ad hoc (gap_buffer drain returns PrevUnknown), which is brittle and forces runtime checks across the replication path.\n\n**Files:** src/core/watermark.rs, src/daemon/store_runtime.rs, src/daemon/repl/session.rs, src/daemon/repl/gap_buffer.rs, src/daemon/repl/runtime.rs","design":"**Design**\n- Introduce a head-known watermark type (e.g., Watermark<K, HeadKnown>) or split Watermark into Known/Maybe variants.\n- Restrict contiguity-critical APIs (advance_contiguous, gap buffer drain) to require head-known watermarks.\n- Decide how to handle peers that omit head hashes: either reject at protocol boundary or store them in a separate \"unknown head\" map until upgraded.\n- Update load_watermarks to reject/flag seq>0 without head unless in a compatibility mode.","id":"bd-9qv0","labels":[],"priority":2,"status":"closed","title":"Make head-knownness explicit in watermarks","type":"chore"}
