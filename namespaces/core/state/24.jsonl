{"_at":[1768468870499,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768444495152,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nREALTIME_PLAN §0.19 requires enforcing MAX_REPL_INGEST_BYTES_PER_SEC and MAX_BACKGROUND_IO_BYTES_PER_SEC (token buckets) so WAL writes aren’t starved. Limits exist but are unused.\n\nEvidence:\n- src/core/limits.rs defines max_repl_ingest_bytes_per_sec / max_background_io_bytes_per_sec.\n- No call sites reference these fields (rg shows only definitions/tests).\n\n**Why this violates plan**\nThese budgets are normative; without enforcement, replication or checkpoints can saturate IO and violate the durability priority rule.\n\n**Acceptance**\n- [ ] Implement token-bucket throttling for replication ingest bytes/sec and background IO.\n- [ ] Ensure WAL append + fsync are not starved by background work.\n- [ ] Add metrics/tests verifying throttling behavior.","id":"bd-3m5.94","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"I/O budgeting limits (bytes/sec) are defined but not enforced","type":"bug"}
{"_at":[1768348610335,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768345739300,0],"created_by":"darin@darinsmcstudio2.lan","description":"","id":"bd-5sd","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Spec-aligned WAL/event invariants and idempotency canonicalization","type":"chore"}
{"_at":[1769555684276,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] ACKs containing any namespace outside negotiated `accepted_namespaces` are rejected with a clear error.\n- [ ] `SessionAction::PeerAck` carries only a validated type (no raw `Ack` in the repl loops).\n- [ ] `update_peer_ack` cannot be called without a validated ACK.\n- [ ] Ordering of watermark maps remains deterministic (BTreeMap order preserved).\n- [ ] Tests cover: allowed ACK, disallowed namespace ACK, mixed allowed+disallowed, and applied=None cases.\n- [ ] `cargo test` passes.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769554076661,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nACK messages are accepted and forwarded to `PeerAckTable` without validating that their namespaces were negotiated in the handshake. `handle_ack` returns the raw `Ack`, and `update_peer_ack` blindly updates state. A peer can send ACKs for namespaces it never accepted (or was never offered), and we will count those toward durability. This violates parse-don’t-validate and makes durability safety depend on peer honesty.\n\n**Impact**\n- False durability success: `DurabilityCoordinator` may count a peer for a namespace it never replicated.\n- Compiler cannot prevent misuse; a refactor can accidentally pass raw ACKs further without guards.\n\n**Files**\n- `crates/beads-rs/src/daemon/repl/session.rs` (message handling + handshake state)\n- `crates/beads-rs/src/daemon/repl/server.rs` / `crates/beads-rs/src/daemon/repl/manager.rs` (`update_peer_ack`)\n- `crates/beads-rs/src/daemon/repl/peer_acks.rs` (ack table)\n","design":"**Design (opinionated)**\nValidate ACKs at the session boundary and make invalid ACKs unrepresentable downstream.\n\n1) Introduce a validated ACK type tied to negotiated namespaces:\n```rust\nstruct ValidatedAck {\n  durable: WatermarkState<Durable>,\n  applied: Option<WatermarkState<Applied>>,\n}\nstruct AllowedNamespaces(BTreeSet<NamespaceId>);\n```\n`AllowedNamespaces` is created from the negotiated `SessionPeer.accepted_namespaces`.\n\n2) In `Session<*, Streaming>::handle_ack`, validate: every namespace in `Ack` is in `AllowedNamespaces`.\n- If any namespace is not allowed, return `InvalidRequest` / `NamespacePolicyViolation` and transition to `Draining` (fail fast).\n- Otherwise, build `ValidatedAck` (optionally filter empty maps) and emit `SessionAction::PeerAck(ValidatedAck)`.\n\n3) Change `SessionAction::PeerAck` to carry `ValidatedAck` (not raw `Ack`).\n- Update `update_peer_ack` to accept `ValidatedAck`.\n- This makes it impossible to update `PeerAckTable` without negotiated-namespace validation.\n\n4) Preserve ordering/determinism by keeping `BTreeMap` ordering; validation should not reorder.\n\n**Why this is parse-don’t-validate**\nWire ACKs are decoded -> validated immediately -> only validated type flows further. No later runtime checks.","id":"bd-si5m","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Repl ACKs must be validated against negotiated namespaces","type":"bug"}
