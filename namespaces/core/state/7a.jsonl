{"_at":[1768279233651,1],"_by":"darin@darinsmacstudio.lan","_v":{"acceptance_criteria":[[1768271759318,1],"darin@darinsmacstudio.lan"],"claim":[[1768278592121,1],"darin@darinsmacstudio.lan"],"description":[[1768271759318,1],"darin@darinsmacstudio.lan"],"design":[[1768271759318,1],"darin@darinsmacstudio.lan"],"estimated_minutes":[[1768271759318,1],"darin@darinsmacstudio.lan"],"external_ref":[[1768271759318,1],"darin@darinsmacstudio.lan"],"labels":[[1768271759318,1],"darin@darinsmacstudio.lan"],"priority":[[1768271759318,1],"darin@darinsmacstudio.lan"],"source_repo":[[1768271759318,1],"darin@darinsmacstudio.lan"],"title":[[1768271759318,1],"darin@darinsmacstudio.lan"],"type":[[1768271759318,1],"darin@darinsmacstudio.lan"]},"assignee":"darin@darinsmacstudio.lan","assignee_at":[1768278592121,1],"assignee_expires":1768282192121,"closed_at":[1768279233651,1],"closed_by":"darin@darinsmacstudio.lan","created_at":[1768271759318,1],"created_by":"darin@darinsmacstudio.lan","description":"**Problem**\nInserting an event with the same (namespace, origin_replica_id, origin_seq) but different sha triggers a SQLite constraint error and is mapped to index_corrupt, leaving equivocation unreachable.\n\n**Where**\n- src/daemon/wal/index.rs: SqliteWalIndexTxn::record_event inserts into events with PK on (namespace, origin_replica_id, origin_seq)\n- src/daemon/ops.rs: wal_index_error_code maps WalIndexError::Sqlite(_) to index_corrupt\n\n**Design**\n- On conflict, detect existing row and compare sha256; if different, emit equivocation with details (namespace, origin_replica_id, origin_seq, expected_sha256, got_sha256).\n- Avoid using generic SQLite error for equivocation.\n\n**Acceptance**\n- Equivocation is reported via ErrorCode::Equivocation, not index_corrupt.\n- Normal duplicate insert with same sha remains idempotent (no error).\n\n**Files**\n- src/daemon/wal/index.rs\n- src/daemon/ops.rs\n- src/daemon/ipc.rs","id":"bd-3m5.72","labels":[],"priority":1,"status":"closed","title":"WAL index: detect equivocation on EventId reuse","type":"bug"}
{"_at":[1768492134064,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1765744422313,0],"darin@book"],"claim":[[1768491083735,1],"darin@book"],"description":[[1765744422313,0],"darin@book"],"design":[[1765744422313,0],"darin@book"],"estimated_minutes":[[1765744422313,0],"darin@book"],"external_ref":[[1765744422313,0],"darin@book"],"labels":[[1765744422313,0],"darin@book"],"priority":[[1765744422313,0],"darin@book"],"source_repo":[[1765744422313,0],"darin@book"],"title":[[1765744422313,0],"darin@book"],"type":[[1765744422313,0],"darin@book"]},"assignee":"darin@book","assignee_at":[1768491083735,1],"assignee_expires":1768494683735,"closed_at":[1768492134064,1],"closed_by":"darin@book","created_at":[1765744422313,0],"created_by":"darin@book","description":"**Problem**\nThe invariant \"live ∩ tombstones = ∅\" is enforced by careful method design:\n```rust\npub struct CanonicalState {\n    live: BTreeMap<BeadId, Bead>,\n    tombstones: BTreeMap<BeadId, Tombstone>,\n    // ...\n}\n```\n\nThis relies on `insert`/`delete` being correct. A bug could violate the invariant.\n\n**Design**\nMake the invariant structurally impossible:\n```rust\npub enum BeadEntry {\n    Live(Bead),\n    Tombstone(Tombstone),\n}\n\npub struct CanonicalState {\n    beads: BTreeMap<BeadId, BeadEntry>,\n    deps: BTreeMap<DepKey, DepEdge>,\n}\n```\n\nNow a bead cannot be both live and tombstoned - the type system prevents it.\n\n**Design Notes**\n- Bigger refactor than the other type improvements\n- Consider doing this when touching `state.rs` for other reasons\n- `get_live`/`get_tombstone` become pattern matches on entry\n- Iteration patterns change (`live.values()` → `beads.values().filter_map(...)`)\n- Wire format (`src/git/wire.rs`) may need adjustment\n\n**Acceptance**\n- [ ] `BeadEntry` enum in `src/core/state.rs`\n- [ ] `CanonicalState` uses single `beads: BTreeMap<BeadId, BeadEntry>`\n- [ ] All accessors (`get_live`, `get_tombstone`, iteration) updated\n- [ ] Wire format handles the change\n- [ ] Invariant comment updated to note its now structural\n- [ ] Tests pass\n\n**Files:** src/core/state.rs, src/git/wire.rs","id":"bd-di1","labels":[],"priority":3,"status":"closed","title":"Collapse live/tombstones into single BeadEntry map","type":"chore"}
