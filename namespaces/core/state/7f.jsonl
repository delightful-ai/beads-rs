{"_at":[1769626630601,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"**Acceptance**\n- [ ] Limits checks are centralized in a policy type with validated wrappers.\n- [ ] Mutation planning uses validated note/patch helpers instead of manual checks.\n- [ ] Event validation uses validated types for size limits.\n- [ ] Checkpoint import uses validated shard helpers for size/depth/entry limits.\n- [ ] WAL framing/record sizing is enforced through the policy helpers.\n- [ ] Tests cover limit violations in at least two boundary paths (event + checkpoint).","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769573215365,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nLimits enforcement is scattered across multiple contexts:\n- Event validation in `crates/beads-core/src/event.rs`\n- Mutation planning in `crates/beads-rs/src/daemon/mutation_engine.rs`\n- Checkpoint import JSONL size/depth checks in `crates/beads-rs/src/git/checkpoint/import.rs`\n- WAL framing/record limits in `crates/beads-rs/src/daemon/wal/*`\n\nThe rules for \"what is allowed\" are duplicated and easy to miss in new paths. This is implicit + scatter and invites drift.\n\n**Files:**\n- `crates/beads-core/src/event.rs`\n- `crates/beads-rs/src/daemon/mutation_engine.rs`\n- `crates/beads-rs/src/git/checkpoint/import.rs`\n- `crates/beads-rs/src/daemon/wal/segment.rs`\n- `crates/beads-rs/src/daemon/wal/record.rs`","design":"**Design**\nCreate a single limits policy module that vends validated inputs, and route all limit checks through it.\n\nConcrete plan:\n1) Introduce a `LimitsPolicy` (or extend `Limits`) with helper constructors like:\n   - `ValidatedNote::try_from(content, limits)`\n   - `ValidatedPatch::try_from(patch, limits)`\n   - `ValidatedFrame::try_from(bytes, limits)`\n   - `ValidatedCheckpointShard::try_from(bytes, limits)`\n2) Update mutation planning, event validation, checkpoint import, and WAL framing to use those validated types.\n3) Remove ad-hoc size/depth checks from callers once the validated type is used.\n\n**Design Notes**\n- Keep the policy in a shared crate (`beads-core`) if possible to avoid cross-crate drift.\n- The goal is a single place to change limits behavior.","id":"bd-8xkm","labels":{"cc":{"max":{}},"entries":{"limits":[{"counter":3706821128463288602,"replica":"da540f92-cee2-1cb4-d9f4-399cb8737519"}],"scatter":[{"counter":14131435385571344916,"replica":"6a55f733-24c1-b0c4-55b4-62a928729da0"}],"tech-debt":[{"counter":14172773698591137036,"replica":"6695de3f-554e-291e-7b5a-a5aee7469a07"}]}},"notes":[{"at":[1769599203862,0],"author":"darin@darins-Mac-Studio-2.local","content":"Note: if any rendering is touched, keep rendering in the command files; do not centralize rendering elsewhere.","id":"go-comment-bd-8xkm-1"},{"at":[1769626630601,0],"author":"darin@darinsmcstudio2.lan","content":"Note: if any rendering is touched, keep rendering in the command files; do not centralize rendering elsewhere.","id":"legacy-notes"}],"priority":2,"status":"closed","title":"Centralize limits enforcement","type":"chore"}
{"_at":[1769033020527,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1769032879591,0],"created_by":"darin@darinsmcstudio2.lan","description":"","id":"bd-9e1s","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Fix canonical CBOR fixtures and lock key ordering","type":"bug"}
