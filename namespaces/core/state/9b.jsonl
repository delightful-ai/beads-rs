{"_at":[1769408930384,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] IpcClient defined in beads-surface\n- [ ] Runtime dir override works (test with temp dir)\n- [ ] Autostart override works\n- [ ] Version check still works with workspace versioning\n- [ ] `cargo check -p beads-surface` passes\n- [ ] `cargo check -p beads-rs` passes\n- [ ] CLI still auto-starts daemon correctly","assignee":"darin@book","created_at":[1769398697324,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`daemon/ipc/client.rs` contains the IPC client but depends on:\n- `crate::paths::config_runtime_dir_override()` - can't access after extraction\n- Autostart spawns `bd daemon run` - needs to be overridable for tests/embedded use\n- Version check uses `env!(\"CARGO_PKG_VERSION\")` - works with workspace versioning\n\n**Changes**\n\n1. **Move file**: `crates/beads-rs/src/daemon/ipc/client.rs` → `crates/beads-surface/src/ipc/client.rs`\n\n2. **Add runtime dir override hook in surface**:\n   ```rust\n   // In beads-surface/src/ipc/client.rs (or separate config.rs)\n   use std::sync::OnceLock;\n   use std::path::PathBuf;\n\n   static RUNTIME_DIR_OVERRIDE: OnceLock<PathBuf> = OnceLock::new();\n\n   pub fn set_runtime_dir_override(dir: PathBuf) {\n       let _ = RUNTIME_DIR_OVERRIDE.set(dir);\n   }\n\n   fn runtime_dir_override() -> Option<&'static PathBuf> {\n       RUNTIME_DIR_OVERRIDE.get()\n   }\n   ```\n   Then `socket_dir_candidates()` checks this override first.\n\n3. **Wire up override from beads-rs**:\n   In `paths::init_from_config` or `main.rs`:\n   ```rust\n   if let Some(dir) = config_runtime_dir() {\n       beads_surface::ipc::set_runtime_dir_override(dir);\n   }\n   ```\n\n4. **Add autostart command override** for tests/embedded usage:\n   ```rust\n   impl IpcClient {\n       /// Override the program/args used for autostart.\n       /// Default spawns `bd daemon run`.\n       pub fn with_autostart_program(mut self, program: PathBuf, args: Vec<OsString>) -> Self {\n           self.autostart_program = Some(program);\n           self.autostart_args = args;\n           self\n       }\n\n       /// Disable autostart entirely.\n       pub fn with_autostart(mut self, enabled: bool) -> Self {\n           self.autostart = enabled;\n           self\n       }\n   }\n   ```\n\n5. **Optional: Add version check override**:\n   ```rust\n   impl IpcClient {\n       /// Allow callers to relax or pin the version check.\n       /// Default uses env!(\"CARGO_PKG_VERSION\").\n       pub fn with_expected_daemon_version(mut self, version: Option<String>) -> Self {\n           self.expected_version = version;\n           self\n       }\n   }\n   ```\n\n6. **Update beads-surface/src/ipc/mod.rs**:\n   ```rust\n   pub mod client;\n   pub mod codec;\n   pub mod types;\n\n   pub use client::*;\n   pub use codec::*;\n   pub use types::*;\n   ```\n\n**Files**\n- crates/beads-surface/src/ipc/client.rs (moved + refactored)\n- crates/beads-surface/src/ipc/mod.rs (re-export)\n- crates/beads-rs/src/paths.rs or main.rs (wire up override)","id":"bd-14fs.9","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Phase 3F: Move IPC client with runtime/autostart overrides","type":"task"}
{"_at":[1768209951422,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darinsmacstudio.lan","created_at":[1768178815664,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nOperators need to recover from stale lock files without manual rm.\n\n**Context**\n- REALTIME_PLAN.md §0.2 (store lock metadata, recovery ergonomics)\n\n**Design**\n- CLI: `bd store unlock --store-id <id>`\n- Reads lock metadata and displays: store_id, replica_id, pid, started_at_ms, daemon_version\n- If pid does not exist: removes lock file (safe case)\n- If pid exists but different process (pid reuse): removes lock file\n- If pid exists and appears to be daemon: requires --force flag\n- Logs unlock action for traceability\n\n**Acceptance**\n- [ ] bd store unlock reads and displays lock metadata\n- [ ] Auto-removes stale locks (pid gone)\n- [ ] Requires --force for live-looking processes\n- [ ] Tests verify safe/force paths\n\n**Files:** src/cli/commands/store.rs (new), src/daemon/store_lock.rs","id":"bd-3m5.36","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 3: bd store unlock CLI for stale lock recovery","type":"task"}
{"_at":[1769559143502,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769309222461,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nThe same 4-line state access pattern appears 50+ times across executor.rs, query_executor.rs, and other daemon modules:\n\n```rust\nlet empty_state = CanonicalState::new();\nlet state = self.store_runtime(&proof)?.state.get(&namespace).unwrap_or(&empty_state);\n```\n\nVariations include:\n- `self.store_runtime(&proof)?` (immutable)\n- `self.store_runtime_mut(&proof)?` (mutable)\n- `.state.get(&namespace).unwrap_or(&empty_state)` vs `.state.ensure_namespace(ns)`\n\nThis duplication adds ~100 lines of boilerplate and makes the access pattern inconsistent.\n\n**Design**\nAdd two helper methods to `Daemon` impl in `src/daemon/core.rs`:\n\n```rust\nimpl Daemon {\n    /// Get namespace state immutably, returning empty state if namespace does not exist\n    fn namespace_state(&self, proof: &LoadedStore, ns: &NamespaceId) -> Result<&CanonicalState, OpError> {\n        static EMPTY: CanonicalState = CanonicalState::new(); // or use OnceCell\n        Ok(self.store_runtime(proof)?\n            .state\n            .get(ns)\n            .unwrap_or(&EMPTY))\n    }\n\n    /// Get or create namespace state mutably\n    fn namespace_state_mut(&mut self, proof: &LoadedStore, ns: NamespaceId) -> Result<&mut CanonicalState, OpError> {\n        Ok(self.store_runtime_mut(proof)?\n            .state\n            .ensure_namespace(ns))\n    }\n}\n```\n\nThen replace all occurrences in:\n- `src/daemon/executor.rs` (~15 occurrences)\n- `src/daemon/query_executor.rs` (~20 occurrences)\n- `src/daemon/mutation_engine.rs` (~10 occurrences)\n\n**Acceptance**\n- [ ] Helper methods added to Daemon impl\n- [ ] All `store_runtime(&proof)?.state.get(&namespace).unwrap_or(&empty)` patterns replaced\n- [ ] All `store_runtime_mut(&proof)?.state.ensure_namespace(ns)` patterns replaced\n- [ ] cargo clippy passes\n- [ ] cargo test passes\n\n**Files:** src/daemon/core.rs, src/daemon/executor.rs, src/daemon/query_executor.rs, src/daemon/mutation_engine.rs","id":"bd-xhdd","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Extract get_or_default_namespace() helper in daemon/core.rs","type":"chore"}
