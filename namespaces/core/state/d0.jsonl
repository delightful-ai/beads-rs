{"_at":[1768253663111,1],"_by":"darin@darinsmacstudio.lan","_v":{"acceptance_criteria":[[1768195775570,1],"darin@darinsmacstudio.lan"],"claim":[[1768253485506,1],"darin@darinsmacstudio.lan"],"description":[[1768252742016,1],"darin@darinsmacstudio.lan"],"design":[[1768180173303,1],"darin@darinsmacstudio.lan"],"estimated_minutes":[[1768178717301,1],"darin@darinsmacstudio.lan"],"external_ref":[[1768178717301,1],"darin@darinsmacstudio.lan"],"labels":[[1768178717301,1],"darin@darinsmacstudio.lan"],"priority":[[1768178717301,1],"darin@darinsmacstudio.lan"],"source_repo":[[1768178717301,1],"darin@darinsmacstudio.lan"],"title":[[1768187789897,1],"darin@darinsmacstudio.lan"],"type":[[1768178717301,1],"darin@darinsmacstudio.lan"]},"acceptance_criteria":"- [ ] Head sha is persisted and reloaded alongside applied and durable watermarks.\n- [ ] API rejects advancing a nonzero seq without a head sha.\n- [ ] StoreRuntime exposes head sha lookup per (namespace, origin) for later prev_sha validation.\n- [ ] Head sha updates are tied to watermark advancement (no stale head).","assignee":"darin@darinsmacstudio.lan","assignee_at":[1768253485506,1],"assignee_expires":1768257085506,"closed_at":[1768253663111,1],"closed_by":"darin@darinsmacstudio.lan","created_at":[1768178717301,1],"created_by":"darin@darinsmacstudio.lan","description":"**Problem**\nHead sha tracking is required to validate prev_sha continuity and to safely advance watermarks. Today we only have seq values, which allows the system to represent seq>0 without knowing the chain head, making continuity checks ambiguous. This bead scopes the Phase 3 core tracking (no replication session wiring).\n\n**Context**\n- REALTIME_PLAN.md 0.12 (head sha rule) + 2.3 (WatermarkHeadMap)\n- Stateright model: beads_stateright_models/src/realtime_types_sketch.rs (HeadStatus)\n\n**Design**\n- Extend watermarks to carry head hash for each (namespace, origin) pair (HeadStatus: Genesis, Known, Unknown).\n- Require head to be Known whenever seq>0; Unknown is allowed only when a checkpoint does not include heads.\n- Persist head sha in the wal.sqlite watermarks table (applied_head_sha, durable_head_sha) and keep in memory in StoreRuntime.\n- Update head sha on WAL append (durable) and after apply_event (applied) so prev_sha validation can use the latest known head.\n- Provide helper API: advance_contiguous(seq, head) and observe_at_least(seq, head) to enforce invariants in one place.\n- Replication session wiring deferred to Phase 5 (bd-3m5.46).\n\n**Acceptance**\n- [ ] Head sha is persisted and reloaded alongside applied and durable watermarks.\n- [ ] API rejects advancing a nonzero seq without a head sha.\n- [ ] StoreRuntime exposes head sha lookup per (namespace, origin) for later prev_sha validation.\n- [ ] Head sha updates are tied to watermark advancement (no stale head).\n\n**Files:** src/core/watermark.rs, src/daemon/store_runtime.rs, src/daemon/wal/index.rs","design":"**Design**\n- Extend watermarks to carry head hash for each (namespace, origin) pair (HeadStatus: Genesis, Known, Unknown).\n- Require head to be Known whenever seq>0; Unknown is allowed only when a checkpoint does not include heads.\n- Persist head sha in the wal.sqlite watermarks table (applied_head_sha, durable_head_sha) and keep in memory in StoreRuntime.\n- Update head sha on WAL append (durable) and after apply_event (applied) so prev_sha validation can use the latest known head.\n- Provide helper API: advance_contiguous(seq, head) and observe_at_least(seq, head) to enforce invariants in one place.","id":"bd-3m5.27","labels":[],"priority":2,"status":"closed","title":"Phase 3: WatermarkHeadMap + head sha tracking","type":"task"}
