{"_at":[1769408229397,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] IpcError defined in beads-surface\n- [ ] encode/decode/framing functions in beads-surface\n- [ ] No impl From<DaemonError> for ErrorPayload (orphan rule)\n- [ ] All 161 error conversions use explicit .to_error_payload()\n- [ ] `cargo check -p beads-surface` passes\n- [ ] `cargo check -p beads-rs` passes","assignee":"darin@book","created_at":[1769398697115,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`daemon/ipc/codec.rs` does two things:\n1. NDJSON framing + JSON encode/decode (belongs in surface)\n2. Mapping daemon errors to ErrorPayload (belongs in daemon)\n\n**Orphan rule issue**:\nCurrently `impl From<OpError> for ErrorPayload` exists. After extraction, ErrorPayload is in beads-core (foreign), OpError is in beads-rs, so this `From` impl becomes illegal.\n\n**Affected impls** (daemon/ipc/codec.rs):\n- Line 23: `impl From<OpError> for ErrorPayload`\n- Line 879: `impl From<IpcError> for ErrorPayload`\n\n**Call sites**: 161 uses of `Response::err(e)` where `e: OpError` relies on implicit conversion.\n\n**Recommended fix** (minimal changes):\n1. Add `IntoErrorPayload` trait in beads-rs:\n   ```rust\n   pub trait IntoErrorPayload {\n       fn into_error_payload(self) -> ErrorPayload;\n   }\n   impl IntoErrorPayload for OpError { ... }\n   ```\n2. Add extension method on Response in beads-rs:\n   ```rust\n   pub trait ResponseExt {\n       fn err_from<E: IntoErrorPayload>(e: E) -> Response;\n   }\n   ```\n3. Find-replace: `Response::err(` → `Response::err_from(` in daemon code\n\nThis keeps surface clean (no `impl Into` bounds) and changes are mechanical.\n\n**Changes**\n\n1. **Move framing code to beads-surface/src/ipc/codec.rs**:\n   - `IpcError` (parse/io/frame-too-large/version mismatch)\n   - `encode_response`, `send_response`, `decode_request_with_limits`, `read_requests`\n\n2. **Create daemon error mapping** `crates/beads-rs/src/daemon/ipc/error_mapping.rs`:\n   - `IntoErrorPayload` trait\n   - `impl IntoErrorPayload for OpError`\n   - `impl IntoErrorPayload for IpcError`\n   - `ResponseExt` trait for `Response::err_from()`\n\n3. **Mechanical find-replace** in daemon code:\n   `Response::err(` → `Response::err_from(`\n\n**Files**\n- crates/beads-surface/src/ipc/codec.rs (framing only)\n- crates/beads-rs/src/daemon/ipc/error_mapping.rs (new)\n- crates/beads-rs/src/daemon/ipc/mod.rs\n- Daemon files (mechanical find-replace)","id":"bd-14fs.8","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Phase 3E: Refactor IPC codec into surface + daemon error mapping","type":"task"}
{"_at":[1769580403378,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769309225358,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nThe Request enum in src/daemon/ipc/types.rs has 11 admin-related variants at the top level:\n- AdminStatus\n- AdminMetrics  \n- AdminDoctor\n- AdminScrub\n- AdminFlush\n- AdminCheckpointWait\n- AdminFingerprint\n- AdminReloadPolicies\n- AdminReloadLimits\n- AdminReloadReplication\n- AdminRotateReplicaId\n- AdminMaintenanceMode\n- AdminRebuildIndex\n\nThis adds cognitive load when pattern matching (47 total variants) and makes the Request enum harder to navigate. Admin operations are a cohesive group that should be nested.\n\n**Design**\n1. Create `AdminOp` enum with all admin variants (without Admin prefix):\n\n```rust\n// src/daemon/ipc/types.rs\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(tag = \"admin_op\", rename_all = \"snake_case\")]\npub enum AdminOp {\n    Status { repo: PathBuf },\n    Metrics { repo: PathBuf },\n    Doctor { repo: PathBuf, fix: bool },\n    Scrub { repo: PathBuf, fix: bool },\n    Flush { repo: PathBuf },\n    CheckpointWait { repo: PathBuf, timeout_ms: Option<u64> },\n    Fingerprint { repo: PathBuf, mode: AdminFingerprintMode, sample: AdminFingerprintSample },\n    ReloadPolicies { repo: PathBuf },\n    ReloadLimits { repo: PathBuf },\n    ReloadReplication { repo: PathBuf },\n    RotateReplicaId { repo: PathBuf },\n    MaintenanceMode { repo: PathBuf, enabled: bool },\n    RebuildIndex { repo: PathBuf },\n}\n```\n\n2. Replace 11 Request variants with one:\n\n```rust\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(tag = \"op\", rename_all = \"snake_case\")]\npub enum Request {\n    // ... other variants\n    Admin(AdminOp),  // Replaces 11 AdminX variants\n}\n```\n\n3. Update dispatch in coord.rs:\n\n```rust\nRequest::Admin(op) => self.handle_admin(op),\n```\n\n4. Update CLI admin.rs handler to construct AdminOp variants\n\n**Design Notes**\n- Wire format changes: `{\"op\": \"admin_status\", ...}` → `{\"op\": \"admin\", \"admin_op\": \"status\", ...}`\n- This is a breaking protocol change — requires IPC_PROTOCOL_VERSION bump to 3\n- Can be done after IPC documentation bead to have clear migration notes\n\n**Acceptance**\n- [ ] AdminOp enum created with all 11 variants\n- [ ] Request enum has single Admin(AdminOp) variant\n- [ ] IPC_PROTOCOL_VERSION bumped to 3\n- [ ] coord.rs dispatch updated\n- [ ] src/cli/commands/admin.rs updated to construct AdminOp\n- [ ] Wire format documented in IPC_PROTOCOL.md\n- [ ] cargo clippy passes\n- [ ] cargo test passes\n- [ ] Integration tests pass\n\n**Files:** src/daemon/ipc/types.rs, src/daemon/coord.rs, src/cli/commands/admin.rs, docs/IPC_PROTOCOL.md","id":"bd-22ka","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Nest admin Request variants under Request::Admin(AdminOp)","type":"chore"}
{"_at":[1765785395172,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1765690392795,0],"created_by":"darin@darinsmcstudio2.lan","description":"## What's Wrong\nBead IDs now support `<slug>-<suffix>` to match beads-go (repo-name slug), but new repos still default to `bd` because slug selection is inferred from existing state.\n\n## Where\n- src/daemon/executor.rs: preferred_bead_slug(...) falls back to \"bd\" when store is empty\n- src/git/wire.rs: meta.json only stores format_version; no place to persist root slug\n\n## Why It Matters\n- Fresh repos should default to the repo-name slug (beads-go parity) or at least allow configuring it.\n- Inferring slug from existing IDs fails for empty stores and is an implicit heuristic.\n\n## Suggested Fix\n- Add `root_slug` to `meta.json` (WireMeta + core Meta), and set it on init (derive from repo dir name or remote URL basename; sanitize).\n- Use persisted `root_slug` for new ID generation.\n- Decide compatibility strategy (format_version bump if needed; ensure old readers ignore unknown fields or gate by version).\n\n## Acceptance\n- After `bd init` in a repo named `foo`, new IDs default to `foo-...` (or a clearly documented rule).\n- `bd create` in an empty store uses `meta.root_slug`, not a heuristic.","id":"bd-b6x","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Persist root slug in meta.json; default new IDs to repo-name","type":"feature"}
{"_at":[1768757653222,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768719776129,0],"created_by":"darin@darinsmcstudio2.lan","description":"src/cli/commands/update.rs fetches issue after updates just to print updated id. For non-JSON output, avoid fetch and print the id from args; keep fetch only for --json.","id":"bd-izhh","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"CLI update: skip fetch for non-JSON output","type":"chore"}
{"_at":[1767919459457,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darinsmacstudio.lan","created_at":[1767916527694,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`Daemon::apply_update` applies `BeadPatch` field-by-field inline in `src/daemon/executor.rs`. The patch semantics live in `src/daemon/ops.rs`, but the actual application logic lives elsewhere, so adding or changing fields requires touching multiple places and is easy to miss.\n\n**Design**\nAdd a helper on `BeadPatch` to apply patches directly to `BeadFields`:\n- Implement `BeadPatch::apply_to_fields(&self, fields: &mut BeadFields, stamp: &Stamp) -> Result<(), OpError>` in `src/daemon/ops.rs`.\n- Move the current field-application logic (including label parsing and status -> workflow transition) into this helper.\n- Update `Daemon::apply_update` to call the helper inside the WAL mutation.\n\n**Design Notes**\nKeep behavior identical: required fields cannot be cleared, label parsing stays strict, and status strings map to the same workflows with the same validation errors.\n\n**Acceptance**\n- [ ] `Daemon::apply_update` delegates patch application to `BeadPatch::apply_to_fields`.\n- [ ] Label validation and workflow transitions behave exactly as before.\n- [ ] Run `codex review --uncommitted` (timeout 10m) and address findings.\n- [ ] Tests pass.\n\n**Files:** `src/daemon/ops.rs`, `src/daemon/executor.rs`","id":"bd-omw.4","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Move BeadPatch application into BeadPatch helper","type":"chore"}
{"_at":[1768758390512,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768719782830,0],"created_by":"darin@darinsmcstudio2.lan","description":"Multiple commands call send() repeatedly (show/update/label/delete/create --file), each opening a Unix socket and version ping. Add a small client wrapper to reuse one connection per command and verify version once.","id":"bd-ps02","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"CLI IPC: reuse daemon connection per command","type":"chore"}
