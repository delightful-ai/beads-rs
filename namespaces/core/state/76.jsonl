{"_at":[1766124452435,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@dusk","created_at":[1766116455164,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nIn `Daemon::complete_sync`, if mutations happened during sync and `CanonicalState::join` fails, the code discards local state and keeps `synced_state`. That can drop mutations made during the sync window.\n\n**Design**\nWhen join fails, detect/resolution collisions (reuse `git::collision` logic) and retry the merge. If merge still fails, keep local state, mark dirty, and surface/log the failure so operators can intervene.\n\n**Acceptance**\n- [ ] Local mutations are never dropped on join failure\n- [ ] Collision resolution is applied for dirty-after-sync merges\n- [ ] Tests cover the join-failure path\n- [ ] Tests pass\n\n**Files:** src/daemon/core.rs, src/git/collision.rs","id":"bd-1p0","labels":{"cc":{"max":{}},"entries":{}},"priority":0,"status":"closed","title":"complete_sync must not drop local mutations on join failure","type":"bug"}
{"_at":[1770509493521,0],"_by":"darin@darinsmcstudio2.lan","_v":{"workflow":[[1770509493492,0],"darin@darinsmcstudio2.lan"]},"assignee":"darin@darins-Mac-Studio-2.local","created_at":[1770508423949,0],"created_by":"darin@darinsmcstudio2.lan","description":"Problem: mutation fixture imports daemon::mutation_engine and daemon::ops::OpError directly. Design: add typed mutation test boundary (surface/daemon-owned) and retarget fixture coverage to boundary API while preserving semantics. Acceptance: mutation fixture no longer imports daemon internals directly; integration behavior remains unchanged and tests pass.","id":"bd-21eg.33","labels":{"cc":{"max":{}},"entries":{}},"notes":[{"at":[1770509493521,0],"author":"darin@darins-Mac-Studio-2.local","content":"Implemented mutation fixture boundary decoupling from daemon internals.\nChanges:\n- `tests/integration/fixtures/mutation.rs` no longer imports `beads_rs::daemon::mutation_engine` or `beads_rs::daemon::ops::OpError`.\n- Added fixture-local typed `MutationContext` and deterministic request-hash helper based on typed context+payload digest.\nValidation:\n- cargo test -p beads-rs --test integration -- wal::idempotency:: (2 pass)\n- cargo check -p beads-rs\nAcceptance met: mutation fixture no longer imports daemon internals; idempotency behavior tests remain green.","id":"go-comment-bd-21eg.33-1"},{"at":[1770509493521,0],"author":"darin@darinsmcstudio2.lan","content":"Implemented mutation fixture boundary decoupling from daemon internals.\nChanges:\n- `tests/integration/fixtures/mutation.rs` no longer imports `beads_rs::daemon::mutation_engine` or `beads_rs::daemon::ops::OpError`.\n- Added fixture-local typed `MutationContext` and deterministic request-hash helper based on typed context+payload digest.\nValidation:\n- cargo test -p beads-rs --test integration -- wal::idempotency:: (2 pass)\n- cargo check -p beads-rs\nAcceptance met: mutation fixture no longer imports daemon internals; idempotency behavior tests remain green.","id":"legacy-notes"}],"priority":2,"status":"closed","title":"Extract mutation-engine fixture boundary API to remove direct daemon mutation internals","type":"task"}
{"_at":[1768000108829,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darinsmacstudio.lan","created_at":[1765744959621,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`run.rs` and `server.rs` both implement near-identical client handling. Duplication.\n\nAlso: `handle_request` has a `SyncWait` branch thats basically dead because the state loop intercepts it.\n\n**Design**\n- Extract shared client handling into single module\n- Prune dead `SyncWait` branch (or make it the single source of truth)\n- Reduce overall code duplication\n\n**Acceptance**\n- [ ] Single client handling implementation\n- [ ] Dead code removed\n- [ ] Existing behavior preserved\n\n**Files:** src/daemon/run.rs, src/daemon/server.rs","id":"bd-cze","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"closed","title":"Unify run.rs and server.rs client handling","type":"chore"}
{"_at":[1768622397302,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768622397302,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nAgents need to communicate asynchronously across rigs/workspaces. The Go beads `bd mail` feature enables inter-agent messaging but currently beads-rs just delegates to external providers (like gt mail). We need native mail functionality.\n\n**What the Feature Does**\nFull inter-agent messaging system with commands:\n- `bd mail send <recipient> --subject <subject> [--body <body>]` - Send a message\n- `bd mail inbox [--unread]` - List received messages\n- `bd mail read <msg-id>` - Read a message\n- `bd mail ack <msg-id>` - Acknowledge/mark as read\n- `bd mail reply <msg-id> --body <body>` - Reply to message (threading)\n\nMessages have:\n- ID (msg-xxx format)\n- From/To (BEADS_IDENTITY or config.identity)\n- Subject/Body\n- replies_to field for threading\n- read/acknowledged status\n- timestamp\n\n**Why It Needs Design Work**\n\n1. **Storage Model**: Should messages be:\n   - Separate JSONL file (`.beads/messages.jsonl`)?\n   - In main database with separate table?\n   - Both (db for queries, JSONL for sync)?\n   - How to handle large message volumes?\n\n2. **Identity System**: \n   - How do agents identify themselves? (BEADS_IDENTITY env var? config?)\n   - How do we validate sender identity?\n   - What about privacy/anonymization?\n   - Cross-rig identity mapping?\n\n3. **Routing & Addressing**:\n   - How do you address recipients? (rig name? prefix? both?)\n   - Does routing use routes.jsonl for delivery?\n   - What about broadcast/group messages?\n   - How to handle offline recipients?\n\n4. **Threading Model**:\n   - replies_to field creates threads\n   - How to display conversation trees?\n   - Do threads need special query support?\n   - What about quoting/context in replies?\n\n5. **Sync Behavior**:\n   - Messages sync via git like issues\n   - But privacy implications - do you want all messages in git history?\n   - Option for local-only messages?\n   - Encryption for sensitive comms?\n\n**Key Decisions to Make**\n\n1. **Schema Design**:\n   - Message data structure (see Go implementation in beads for reference)\n   - Index strategy (by recipient, by thread, by read status)\n   - JSONL format vs database-only\n\n2. **Delivery Semantics**:\n   - Push (via git sync) vs Pull (recipient checks)?\n   - Notification mechanism?\n   - Delivery confirmation?\n\n3. **Delegation Model**:\n   - Go beads delegates to external providers (gt mail)\n   - Should beads-rs also support delegation?\n   - Or always use built-in implementation?\n   - Configuration: `mail.delegate` for backward compat?\n\n4. **Message Types**:\n   - Plain text only or structured (JSON)?\n   - Attachments (issue references, diffs)?\n   - Special message types (notifications, alerts)?\n\n**Trade-offs to Consider**\n\n1. **Git History Pollution**:\n   - Pro: Messages sync automatically\n   - Con: Clutters git log, privacy concerns\n   - Option: Separate branch for messages?\n\n2. **Complexity**:\n   - Full mail system is complex\n   - Could start minimal (send/inbox only)\n   - Add threading/ack later\n\n3. **Delegation vs Native**:\n   - Delegation (Go approach): Simpler, reuses existing infra\n   - Native: Better integration, no external deps\n   - Hybrid: Support both?\n\n**Reference Files in Go Beads**\n- `/Users/darin/Projects/beads-rs-macstudio/tmp/beads/cmd/bd/mail.go` - Delegation approach\n- Look for mail implementation in orchestrator (gt) for full example\n- AGENTS.md mentions mail but no detailed spec found\n\n**Acceptance**\n- [ ] Design document describing storage model, schema, and sync behavior\n- [ ] Identity system design (how agents identify themselves)\n- [ ] Routing and addressing spec\n- [ ] API design for mail commands\n- [ ] Decision on delegation vs native implementation\n- [ ] Privacy/security considerations documented","id":"bd-ze0x.3","labels":{"cc":{"max":{}},"entries":{"human-needed":[{"counter":7287367238972670084,"replica":"8fb37d17-5720-a0fd-02b5-11ada42e2ded"}]}},"priority":2,"status":"open","title":"Mail system - Inter-agent messaging","type":"feature"}
