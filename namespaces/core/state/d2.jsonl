{"_at":[1767995059041,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darinsmacstudio.lan","created_at":[1767992679576,0],"created_by":"darin@darinsmcstudio2.lan","description":"","id":"bd-d2z","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"GC floor must retroactively clear applied events <= floor for order-independent convergence; add regression test around NamespaceGcMarker apply (see gc_floor_machine)","type":"bug"}
{"_at":[1770591196893,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] No ad-hoc `unsafe` blocks remain in `beads-surface/src/ipc/client.rs` for autostart FD cleanup.\n- [ ] Existing autostart/lifecycle integration tests remain green and non-flaky.\n- [ ] A regression test or stress harness demonstrates no inherited-FD hang in the covered scenario.\n- [ ] `cargo clippy --all-features -- -D warnings` passes.\n- [ ] `cargo test --all-features` passes.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1770580097883,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`beads-surface` IPC client autostart currently uses `unsafe` (`CommandExt::pre_exec` + raw fd close loop) to prevent file-descriptor leakage into daemon children. This fixed a real test-hang/flakiness class, but leaves maintainability/policy drift in a boundary crate.\n\nCurrent path:\n- `crates/beads-surface/src/ipc/client.rs`\n  - `prepare_daemon_spawn_command`\n  - `close_non_stdio_fds`\n\n**Goal**\nPreserve the FD-leak fix behavior while removing local `unsafe` from this code path (or strictly isolating it behind a dedicated, justified boundary).\n\n**Files**\n- crates/beads-surface/src/ipc/client.rs\n- crates/beads-daemon/** (if daemon-side early-close strategy is used)\n- crates/beads-rs/tests/integration/** (behavior/flakiness regression coverage)","design":"1. Evaluate safe alternatives to current `pre_exec` strategy (preferred: daemon-side early descriptor cleanup before runtime setup).\n2. Keep behavior invariant: daemon spawn must not inherit arbitrary test harness/capture pipe FDs.\n3. If daemon-side move is used, ensure cleanup runs before any long-lived background activity.\n4. Add regression coverage that would catch descriptor-leak hangs in lifecycle/concurrency tests.\n5. Document rationale and final boundary ownership in architecture notes.","id":"bd-m4vg","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Remove unsafe from IPC autostart FD cleanup path without regressing flake fix","type":"chore"}
{"_at":[1768416090694,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768411789433,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nRealtime integration tests start the daemon via `bd` auto-start but do not shut it down. `RealtimeFixture` drops only restore env (no `Request::Shutdown`), and `AdminFixture` has no Drop cleanup. `tests/critical_path.rs` and `tests/migration.rs` also auto-start the daemon and never shut it down (only one test does best-effort). This leaves orphaned `bd daemon run` processes, stale sockets/locks, and makes repeated test runs flaky on developer machines and CI.\n\nEvidence:\n- `tests/fixtures/realtime.rs` Drop only restores env (lines 77-80).\n- `tests/phase7_admin.rs`, `tests/phase7_admin_status.rs`, `tests/phase7_subscribe.rs` use `RealtimeFixture::start_daemon()` and never stop it.\n- `tests/critical_path.rs`/`tests/migration.rs` use `bd` CLI without teardown.\n\n**Design**\n- Add a shared test helper `shutdown_daemon(runtime_dir: &Path)` (new `tests/fixtures/daemon_runtime.rs` or similar).\n- Implement shutdown by sending IPC `Request::Shutdown` to `beads/daemon.sock`, waiting for ack or socket removal; fall back to SIGTERM/SIGKILL if the process is still alive after a timeout.\n- Make the helper idempotent (missing socket/meta -> Ok).\n- Call this helper from Drop for `RealtimeFixture` and `AdminFixture`, and from the runtime fixture used by `critical_path`/`migration`.\n\n**Acceptance**\n- [ ] Any test that auto-starts the daemon shuts it down during Drop (socket + meta removed).\n- [ ] `cargo test` leaves no `bd daemon run` processes behind.\n- [ ] Helper is used by phase7 realtime tests and other integration tests that spawn the daemon.\n\n**Files:**\n- tests/fixtures/realtime.rs\n- tests/phase7_admin.rs\n- tests/phase7_admin_status.rs\n- tests/phase7_subscribe.rs\n- tests/critical_path.rs\n- tests/migration.rs\n- tests/fixtures/daemon_runtime.rs (new)","id":"bd-o83","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"tests: realtime fixtures leak daemon processes","type":"bug"}
