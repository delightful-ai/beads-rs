{"_at":[1767918180661,1],"_by":"darin@darinsmacstudio.lan","_v":{"acceptance_criteria":[[1767915293605,1],"darin@darinsmacstudio.lan"],"claim":[[1767916891362,1],"darin@darinsmacstudio.lan"],"description":[[1767917070105,1],"darin@darinsmacstudio.lan"],"design":[[1767915293605,1],"darin@darinsmacstudio.lan"],"estimated_minutes":[[1767915293605,1],"darin@darinsmacstudio.lan"],"external_ref":[[1767915293605,1],"darin@darinsmacstudio.lan"],"labels":[[1767915293605,1],"darin@darinsmacstudio.lan"],"priority":[[1767915293605,1],"darin@darinsmacstudio.lan"],"source_repo":[[1767915293605,1],"darin@darinsmacstudio.lan"],"title":[[1767915316318,1],"darin@darinsmacstudio.lan"],"type":[[1767915293605,1],"darin@darinsmacstudio.lan"]},"assignee":"darin@darinsmacstudio.lan","assignee_at":[1767916891362,1],"assignee_expires":1767920491362,"closed_at":[1767918180661,1],"closed_by":"darin@darinsmacstudio.lan","created_at":[1767915293605,1],"created_by":"darin@darinsmacstudio.lan","description":"**Problem**\nFirst access to a repo blocks the daemon in `Daemon::ensure_repo_loaded` while waiting for `GitOp::Load` to finish. `GitWorker::load` always performs a remote fetch (even in best-effort mode). If SSH auth is misconfigured (no agent / passphrase prompt / stalled handshake), libgit2 fetch can hang. Because `ensure_repo_loaded` waits synchronously, the state thread blocks and IPC requests like `bd status` hang indefinitely. We saw `bd status` time out on this machine before SSH auth was configured.\n\n**Design**\nMake load non-blocking, and treat timeouts as a guardrail rather than the primary fix:\n- Split `GitWorker::load` into a fast local-only load (read local ref, compute state) and a remote refresh path.\n- Change `ensure_repo_loaded` to return local state immediately and, if the repo is stale, enqueue a background `GitOp::Refresh` (or `GitOp::Fetch`) without blocking.\n- Only block on remote fetch when no local ref exists; add a bounded timeout (default ~30s, configurable) and return a clean, actionable error on timeout with diagnostic info (SSH agent/auth hints, remote URL).\n- Surface fetch/auth errors via `fetch_error` and Sync warnings, but keep IPC responsive.\n\n**Design Notes**\nThe primary goal is responsiveness: read-only queries must not block on network or auth. Use best-effort refresh for freshness, but never let it block IPC. Timeout is a secondary safety net for unavoidable fetches. Keep existing CRDT merge semantics intact.\n\n**Acceptance**\n- [ ] `bd status` returns promptly (e.g., <1s) when SSH auth is missing/invalid; no hang.\n- [ ] If local ref exists, initial load is non-blocking and refresh happens in the background.\n- [ ] If no local ref exists, the initial fetch is bounded by a default ~30s timeout and returns a clean, actionable error on timeout with diagnostics.\n- [ ] Fetch/auth failures appear as warnings (`fetch_error`) but do not block IPC responses.\n- [ ] Background refresh still updates cached state once auth/network is available.\n- [ ] Run `codex review --uncommitted` (timeout 10m) and address findings.\n- [ ] Tests pass.\n\n**Files:** `src/daemon/core.rs`, `src/daemon/git_worker.rs`, `src/git/sync.rs`","id":"bd-7zf","labels":[],"priority":0,"status":"closed","title":"Daemon load blocks on SSH auth, hangs IPC","type":"bug"}
