{"_at":[1768524713212,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] `Session` can’t represent a streaming phase without peer metadata (no runtime `peer == None` checks).\n- [ ] `handle_events` no longer emits \"missing peer metadata\" internal errors.\n- [ ] Session tests updated/added to cover state transitions and invariants.","assignee":"darin@book","created_at":[1768506331516,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`Session` tracks `phase: SessionPhase` and `peer: Option<SessionPeer>` separately. Streaming-only handlers (e.g. `handle_events`) can still observe `peer == None` and emit an internal error (\"missing peer metadata while handling events\"). Invariants like “Streaming implies peer is set” are enforced with runtime checks and duplicated phase guards, which is brittle and easy to regress.\n\n**Files**\n- src/daemon/repl/session.rs\n","design":"**Design**\nIntroduce a state/typestate representation that encodes invariants:\n- Use `enum SessionState { Connecting{...}, Handshaking{...}, Streaming{peer: SessionPeer, ...}, Draining{peer: SessionPeer, ...}, Closed }` (or generic typestates) and move `peer` into the streaming/draining variants.\n- Refactor `handle_message` to pattern-match on state; only streaming/draining variants accept EVENTS/ACK/WANT/PING/PONG.\n- Remove the internal-error path for missing peer metadata and make it unrepresentable.","id":"bd-ms6b","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Replication Session should encode phase/peer invariants","type":"chore"}
