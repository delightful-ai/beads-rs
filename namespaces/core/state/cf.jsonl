{"_at":[1768474444255,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768444207021,1],"darin@book"],"claim":[[1768473973015,1],"darin@book"],"description":[[1768444207021,1],"darin@book"],"design":[[1768444207021,1],"darin@book"],"estimated_minutes":[[1768444207021,1],"darin@book"],"external_ref":[[1768444207021,1],"darin@book"],"labels":[[1768444207021,1],"darin@book"],"priority":[[1768444207021,1],"darin@book"],"source_repo":[[1768444207021,1],"darin@book"],"title":[[1768444207021,1],"darin@book"],"type":[[1768444207021,1],"darin@book"]},"acceptance_criteria":"- [ ] Broadcast/hot‑cache can hold opaque bytes without type lies.\n- [ ] Canonical bytes are only constructed via canonical encoder (or via an explicit `*_unchecked`).\n- [ ] No `EventBytes<Canonical>` created from opaque remote bytes.","assignee":"darin@book","assignee_at":[1768473973015,1],"assignee_expires":1768477573015,"closed_at":[1768474444255,1],"closed_by":"darin@book","created_at":[1768444207021,1],"created_by":"darin@book","description":"**Problem**\n`BroadcastEvent` requires `EventBytes<Canonical>`, but replication ingest accepts `EventBytes<Opaque>` and may forward non‑canonical CBOR bytes (allowed in v0.5). In `ingest_remote_batch` we wrap opaque bytes as canonical, so the type lies about the invariant.\n\n**Signals / Evidence**\n- `BroadcastEvent.bytes: EventBytes<Canonical>` (`src/daemon/broadcast.rs`).\n- Remote ingest constructs `BroadcastEvent` by wrapping `EventBytes<Opaque>` into `EventBytes<Canonical>` (`src/daemon/core.rs`).\n- `EventBytes<Canonical>::new` is public, so any caller can claim canonicality without validation.\n\n**Why this hurts velocity**\nThis is a classic “types lying” case. It makes it impossible to reason about whether bytes are canonical and forces reviewers to audit every call site instead of trusting the type.","design":"**Design**\n- Change `BroadcastEvent` to carry `EventBytes<Opaque>` (or add an enum/marker for `Canonical | Opaque`).\n- Only label bytes as canonical when produced by the canonical encoder.\n- Restrict `EventBytes<Canonical>::new` to `pub(crate)` and expose a constructor that actually enforces canonical encoding (or rename to `new_unchecked` with clear semantics).\n- Update replication broadcast/hot‑cache to use opaque bytes and avoid implicit canonical claims.","id":"bd-ayl","labels":[],"priority":2,"status":"closed","title":"BroadcastEvent should not require canonical bytes (type-state leak)","type":"task"}
