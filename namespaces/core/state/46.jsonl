{"_at":[1768198447469,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Canonical encode produces stable bytes and hashes across runs (unit tests).\n- [ ] Decoder rejects indefinite length and out of bounds payloads.\n- [ ] EventBytes typestate is used in frame or WAL APIs to prevent hash preimage ambiguity.","assignee":"darin@darinsmacstudio.lan","created_at":[1768177760012,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nRealtime WAL and replication require a canonical EventBody representation whose bytes are the hash preimage. There is no EventBody type or canonical encoding path in core yet, so we cannot guarantee stable hashing or verify remote frames.\n\n**Context**\n- REALTIME_PLAN.md 0.6 (canonical CBOR + hash over EventBody bytes), 2.4 (EventBody fields), 9.4 (EVENTS frame)\n- Stateright model: beads_stateright_models/src/realtime_types_sketch.rs (EventBytes, EventFrameV1, VerifiedEvent)\n\n**Files:** src/core/event.rs (new), src/core/mod.rs, Cargo.toml (minicbor), tests under src/core","design":"**Design**\n- Define EventBody, EventKindV1, and EventId in src/core/event.rs with StoreIdentity and NamespaceId baked in.\n- Add EventBytes<Canonical> and EventBytes<Opaque> wrappers to separate locally authored canonical bytes from opaque remote bytes.\n- Implement canonical CBOR encoder for EventBody using minicbor with definite lengths and sorted map keys for hashed types; reject floats and indefinite lengths.\n- Provide helpers: encode_event_body_canonical -> EventBytes<Canonical>, hash_event_body -> Sha256.\n- Add decode with strict bounds (depth, map entries, byte length) and return EventBytes<Opaque> + EventBody.","id":"bd-3m5.5","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 2: EventBody canonical CBOR + hashing","type":"task"}
{"_at":[1768457113410,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Mismatch between `event_time_ms` and `hlc_max.physical_ms` is rejected at decode/verify.\n- [ ] Tests cover mismatch and success cases.","assignee":"darin@book","created_at":[1768444169778,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\n`event_time_ms` and `hlc_max.physical_ms` can diverge, but we never validate their equality. `apply_event` derives the write stamp from `event_time_ms` + `hlc_max.logical`, so a mismatched `event_time_ms` silently produces a stamp that doesn’t match the event’s stated HLC. This violates the spec invariant that `event_time_ms` equals the physical time used for stamps.\n\n**Signals / Evidence**\n- `apply_event` uses `WriteStamp::new(body.event_time_ms, hlc_max.logical)` (`src/core/apply.rs`).\n- `decode_event_body` only checks that `hlc_max` exists for TxnV1, not that it agrees with `event_time_ms` (`src/core/event.rs`).\n- Mutation planning sets both from the same clock, but remote events could be malformed and still be accepted.\n\n**Why this hurts velocity**\nThis is a silent invariant violation: if we ever need to reason about stamp ordering across replicas or debug clock issues, we can’t trust the stored data. It’s a latent correctness and observability trap.","design":"**Design**\n- Add validation during decode/verify: if `hlc_max` is present, require `hlc_max.physical_ms == event_time_ms`.\n- On mismatch, return a structured `DecodeError::InvalidField` (or a dedicated error) so it maps to `invalid_request`/`corruption` per policy.\n- Add tests for mismatch rejection and match acceptance.","id":"bd-c2r","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Enforce HLC invariants: event_time_ms must match hlc_max.physical_ms","type":"bug"}
{"_at":[1768680829687,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"**Acceptance**\n- [ ] Stateright models compile against production APIs; no re-implemented replicas of realtime types/hashing/contiguity logic remain in the model crate.\n- [ ] repl_core + durability_quorum + idempotency_receipt models use production functions for state transitions.\n- [ ] CI/slow-tests (or a documented command) runs a model build that fails on production API drift.\n- [ ] README in `beads_stateright_models` states the no-drift rule and how to run the production-backed models.","closed_reason":"split into bd-0863 bd-cfqx bd-1bs5 bd-5xvc bd-np77 bd-3fsg","created_at":[1768679264080,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nStateright models in `beads_stateright_models` re-implement core realtime logic (spec types, hashing, contiguity rules), so they can silently drift from production. This violates the requirement in bd-lzhq: invariants must be checked against the actual implementation. We need a hard guarantee that model transitions use production code paths and compile break when prod changes.\n\n**Scope**\nThis is about syncing models with production: replication ingest, gap buffering, watermarks, durability quorum, idempotency/receipts, and apply semantics. The goal is no duplicated logic in the model crate.","design":"**Design**\n1) Make `beads_stateright_models` depend on the main crate (path dep) and use production APIs directly.\n   - Add a dedicated model harness module in `beads-rs` (e.g. `src/model/*` behind a `model-testing` feature) exposing *pure* adapters for Stateright:\n     - Event generation helpers (canonical EventBody + EventFrameV1 encoding)\n     - `verify_event_frame` from `src/core/event.rs`\n     - `GapBufferByNsOrigin` from `src/daemon/repl/gap_buffer.rs`\n     - `apply_event` from `src/core/apply.rs`\n     - `PeerAckTable` + `DurabilityCoordinator::poll_replicated`\n     - Memory WAL/index and `TestClock` from `src/daemon/wal/*` + `src/test_harness/mod.rs`\n2) Replace toy types and logic in `beads_stateright_models/src/spec.rs`, `realtime_types_sketch.rs`, and `toy_codec.rs` with production types or thin adapters. If anything must remain toy, it must be isolated and explicitly justified.\n3) Update at least repl_core, durability_quorum, and idempotency_receipt models to call production functions for transitions and validation.\n4) Enforce “no drift” at build time:\n   - CI/slow-tests runs `cargo check -p beads_stateright_models` (or equivalent) so production changes break models.\n   - Add a small compile-time contract test (feature-gated) that imports all production types used by models so signature changes fail fast.\n5) Use Stateright ActorModel for the replication seam so the network semantics come from Stateright, not custom model code.\n   - Consult Stateright source for actor + network hooks:\n     - `~/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/stateright-0.31.0/src/actor.rs`\n     - `~/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/stateright-0.31.0/src/actor/model.rs`\n     - `~/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/stateright-0.31.0/src/actor/network.rs`\n     - `~/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/stateright-0.31.0/src/actor/ordered_reliable_link.rs`\n     - Example: `~/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/stateright-0.31.0/examples/linearizable-register.rs`\n   - Model should select network semantics (`Network::Ordered` vs `Network::UnorderedDuplicating`, `LossyNetwork` toggles) instead of ad hoc action scheduling.\n   - Use `record_msg_in` / `record_msg_out` + `within_boundary` to track invariants and keep state space bounded.\n6) Consider Stateright’s built-in consistency testers for read/receipt semantics:\n   - `src/semantics/linearizability.rs`\n   - `src/semantics/sequential_consistency.rs`\n   - `src/semantics/register.rs` or `write_once_register.rs` when we model read/write histories.\n\n**Notes**\nIf Stateright state can’t hold non-Hash types, store minimal summaries (watermark maps, event ids, digests) and rebuild production structs inside transitions. Prefer ActorModel (message-level) for repl seam; keep other seams as smaller models or ActorModel subsystems to avoid state explosion.","id":"bd-i43y","labels":{"cc":{"max":{}},"entries":{}},"priority":0,"status":"closed","title":"Realtime: production-backed Stateright models (no drift)","type":"bug"}
{"_at":[1768622452519,0],"_by":"darin@darinsmcstudio2.lan","created_at":[1768622452519,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nNeed bd mol bond for dynamic molecule composition - attaching work graphs at runtime. Bond is polymorphic and handles proto+proto, proto+mol, mol+mol operands.\n\n**What is Bond?**\nBond creates dependencies between work graphs. It's polymorphic:\n- proto + proto → compound proto (reusable template)\n- proto + mol → spawn proto, attach to molecule  \n- mol + mol → join molecules with dependency\n\n**Bond Types**\n- sequential (default): B waits for A to complete\n- parallel: B runs alongside A (organizational link)\n- conditional: B runs only if A fails\n\n**Dynamic Bonding (Christmas Ornament Pattern)**\nUse --ref for custom child IDs with variable substitution:\n- bd mol bond mol-arm patrol --ref arm-{{name}} --var name=ace\n- Creates: patrol.arm-ace (readable ID instead of hash)\n\n**Phase Control**\n- Default: Follow target's phase (ephemeral target → ephemeral spawn)\n- --pour: Force persistent spawn (Ephemeral=false)\n- --ephemeral: Force ephemeral spawn (Ephemeral=true)\n\n**How it Works (Go beads)**\n1. Resolve operands (formula, proto, or mol)\n2. Cook formulas inline if needed\n3. Clone proto if attaching to mol\n4. Create dependency edge with specified bond type\n5. Handle ref substitution for custom child IDs\n\n**Command Syntax**\nbd mol bond <A> <B> [--type sequential|parallel|conditional] [--ref child-ref] [--var k=v]... [--pour|--ephemeral]\n\n**Examples**\n- bd mol bond mol-feature mol-deploy  # compound proto\n- bd mol bond mol-feature bd-abc123  # attach to molecule\n- bd mol bond bd-abc123 bd-def456  # join molecules\n- bd mol bond mol-arm patrol --ref arm-{{name}} --var name=ace  # dynamic ID\n\n**Design Considerations**\n- Polymorphic dispatch based on operand types\n- Formula inline cooking (ephemeral protos)\n- Variable substitution for --ref\n- Phase inheritance vs --pour/--ephemeral override\n- BondRef tracking in Issue.bonded_from\n\n**Files to Study (Go beads)**\n- cmd/bd/mol_bond.go - bond command (polymorphic logic)\n- cmd/bd/template.go - cloneSubgraph with CloneOptions\n- docs/MOLECULES.md - bonding patterns (line 91-116)\n\n**Acceptance**\n- [ ] bd mol bond command implemented\n- [ ] Polymorphic operand handling\n- [ ] Bond type support (sequential/parallel/conditional)\n- [ ] --ref flag for custom child IDs\n- [ ] Variable substitution in refs\n- [ ] Phase control (--pour / --ephemeral)\n- [ ] BondRef tracking\n- [ ] Tests for all bond combinations\n","id":"bd-ze0x.22","labels":{"cc":{"max":{}},"entries":{"human-needed":[{"counter":11986892603917172928,"replica":"70613446-365e-2f5d-d74a-1e06afe8f9cc"}]}},"priority":1,"status":"open","title":"Add bd mol bond command to beads-rs","type":"feature"}
