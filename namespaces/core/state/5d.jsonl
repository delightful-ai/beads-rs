{"_at":[1768195767984,0],"_by":"darin@darinsmcstudio2.lan","_v":{"workflow":[[1768183997123,0],"darin@darinsmcstudio2.lan"]},"acceptance_criteria":"- [ ] WatermarkMap and WatermarkHeadMap helpers enforce contiguous advance and head sha required for seq > 0.\n- [ ] Seq0/Seq1 helpers behave as expected and are used by Watermark APIs.\n- [ ] DurabilityClass cannot represent k=0; DurabilityOutcome encodes pending vs achieved explicitly.\n- [ ] serde roundtrip tests for WatermarkMap/WatermarkHeadMap and DurabilityClass/Outcome.","assignee":"darin@darinsmacstudio.lan","created_at":[1768177732086,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nRealtime semantics require explicit applied vs durable watermarks and head hash tracking. Today there is no watermark type, no seq0 vs seq1 distinction, and receipts cannot represent pending or partial durability without ambiguity.\n\n**Context**\n- REALTIME_PLAN.md 0.12 (applied vs durable), 0.12 head sha rule, 10.1 (durability classes), 16.1 (receipt shape)\n- Stateright model: beads_stateright_models/src/realtime_types_sketch.rs (Watermarks, Watermark, HeadStatus, DurabilityClass, DurabilityOutcome)\n\n**Files:** src/core/watermark.rs (new), src/core/durability.rs (new), src/core/mod.rs, src/lib.rs","design":"**Design**\n- Add Seq0 and Seq1 newtypes: Seq0 for highest contiguous seen, Seq1 for actual event origin_seq (1 based). Provide helpers next(), prev(), prev_seq0().\n- Add Watermark<K> that couples Seq0 with HeadStatus (Genesis, Known(sha), Unknown). This prevents representing seq>0 with no head.\n- Add Watermarks<Applied> and Watermarks<Durable> maps keyed by (NamespaceId, ReplicaId) with helpers advance_contiguous and observe_at_least that enforce head requirements.\n- Add DurabilityClass with ReplicatedFsync using NonZeroU32 for k; add DurabilityOutcome (Achieved vs Pending) and DurabilityProofV1 to express receipts without ambiguous Option fields.\n- Keep types serde friendly for IPC and WAL metadata.","id":"bd-3m5.3","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 1: Watermarks + durability types","type":"task"}
{"_at":[1768395325944,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768178784608,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nOperators need bounded health checks with deterministic remediation actions.\n\n**Context**\n- REALTIME_PLAN.md ยง16.1 (admin.doctor, admin.scrub_now)\n\n**Design**\n- admin.doctor: runs bounded health scrub, returns machine-readable JSON with:\n  - checks: [{ id, status, severity, evidence, suggested_actions }]\n  - summary: { risk, safe_to_accept_writes, safe_to_prune_wal, safe_to_rebuild_index }\n  - Must include explicit remediation actions (exact admin ops to run)\n- admin.scrub_now: samples N events per namespace (default 200), verifies WAL CRC32c and sha256, verifies SQLite offsets, optionally verifies checkpoint_cache\n  - Returns structured pass/warn/fail results\n\n**Acceptance**\n- [ ] admin.doctor returns structured checks with remediation\n- [ ] admin.scrub_now samples and verifies bounded records\n- [ ] CLI `bd admin doctor` and `bd admin scrub` work\n- [ ] Tests verify check detection\n\n**Files:** src/daemon/admin.rs, src/daemon/scrubber.rs (new), src/cli/commands/admin.rs","id":"bd-3m5.32","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 7: admin.doctor + admin.scrub_now IPC ops","type":"task"}
{"_at":[1769590164941,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"**Acceptance**\n- [ ] `root_slug` uses a validated newtype (or `BeadSlug`) end-to-end; no `Option<String>` remains in sync/mutation/meta paths.\n- [ ] All raw slug inputs are validated exactly once at the boundary (CLI/migration/import).\n- [ ] Checkpoint path types are validated and used in snapshot payloads instead of raw `String`.\n- [ ] `parse_shard_path` returns a validated path type; path validation logic is centralized.\n- [ ] JSON serialization remains stable (strings on the wire).\n- [ ] Tests cover invalid slug/path rejection and roundtrip serialization.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769573146615,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nCore identifiers and checkpoint paths are stringly-typed across crates:\n- `root_slug: Option<String>` in `crates/beads-core/src/meta.rs`, `crates/beads-rs/src/git/sync.rs`, `crates/beads-rs/src/daemon/mutation_engine.rs`, and migration code\n- Checkpoint shard paths are raw `String` in `crates/beads-rs/src/git/checkpoint/layout.rs` and `crates/beads-rs/src/git/checkpoint/types.rs`\n\nThis forces repeated parsing/normalization and makes it easy to forget validation in new call paths. The same rules are re-implemented in multiple places (scatter + translation).\n\n**Files:**\n- `crates/beads-core/src/meta.rs`\n- `crates/beads-core/src/identity.rs`\n- `crates/beads-rs/src/git/sync.rs`\n- `crates/beads-rs/src/daemon/mutation_engine.rs`\n- `crates/beads-rs/src/git/checkpoint/layout.rs`\n- `crates/beads-rs/src/git/checkpoint/types.rs`\n- `crates/beads-rs/src/cli/mod.rs`","design":"**Design**\nIntroduce validated newtypes for root slug and checkpoint paths, and make them the only constructors used across crates.\n\nConcrete plan:\n1) Add a `RootSlug` (or reuse `BeadSlug`) newtype in `beads-core` for root slug. Provide `parse` and `as_str` helpers, and implement `Serialize`/`Deserialize` to preserve JSON compatibility.\n2) Replace `Option<String>` root_slug fields with `Option<RootSlug>` (or `Option<BeadSlug>`) in core meta and git sync structs. Provide explicit conversion points where raw strings enter (CLI flags, migration import).\n3) For checkpoint paths, add:\n   - `CheckpointShardName` (validates `xx.jsonl` hex format)\n   - `CheckpointRelPath` / `CheckpointShardPath` as a validated wrapper around the current string-based path\n   - Methods to render to string when writing to disk\n4) Update checkpoint snapshot payload (`CheckpointShardPayload`/`CheckpointSnapshot`) to use validated path types.\n5) Update parsing helpers (`parse_shard_path`) to return the new types and move path validation into their constructors.\n\n**Design Notes**\n- Keep JSON compatibility by serializing newtypes as strings.\n- Keep the raw-string constructors private to ensure no new call path bypasses validation.\n- Where multiple crates need the type, place it in `beads-core` (or a small shared module under `beads-rs` if truly checkpoint-specific).","id":"bd-oybi","labels":{"cc":{"max":{}},"entries":{"scatter":[{"counter":10343354840535972593,"replica":"6f316bb8-ea0e-ab2a-d87f-e90d22752386"}],"tech-debt":[{"counter":3757700608173678545,"replica":"5a06d3fc-6f6d-07fa-d087-7ebe04d2004c"}],"types":[{"counter":7431944384248101420,"replica":"d3bd6222-d771-f22f-ec24-29a78e5bbdf9"}]}},"notes":[{"at":[1769589301774,0],"author":"darin@darins-Mac-Studio-2.local","content":"Rendering should stay in command files; avoid centralizing output rendering in shared helpers.","id":"go-comment-bd-oybi-1"},{"at":[1769590164941,0],"author":"darin@darinsmcstudio2.lan","content":"Rendering should stay in command files; avoid centralizing output rendering in shared helpers.","id":"legacy-notes"}],"priority":2,"status":"closed","title":"Type root slug and checkpoint paths","type":"chore"}
