{"_at":[1768416307751,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768411817049,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nTests that mutate global env use separate locks, so env changes are not serialized across the test suite. `tests/fixtures/realtime.rs` and `tests/fixtures/store_dir.rs` each define their own static `ENV_LOCK`, meaning concurrent tests can stomp on BD_DATA_DIR/XDG_RUNTIME_DIR and cause flakiness (especially with realtime phase tests that rely on RealtimeFixture). This also makes it unsafe to run `cargo test` with multiple threads.\n\nEvidence:\n- `tests/fixtures/realtime.rs` defines `static ENV_LOCK` (line 12) and sets XDG_RUNTIME_DIR/BD_DATA_DIR globally.\n- `tests/fixtures/store_dir.rs` defines a separate `static ENV_LOCK` (line 9) and sets BD_DATA_DIR globally.\n\n**Design**\n- Introduce a single global env guard (e.g., `tests/fixtures/env_guard.rs`) and have all fixtures that mutate env acquire it.\n- Alternatively, avoid global env mutation by using `paths::set_data_dir_for_tests` / `lock_data_dir_for_tests` for in-process tests and passing env per Command for CLI tests.\n- Remove duplicated ENV_LOCKs once the shared guard is in place.\n\n**Acceptance**\n- [ ] All tests that change env use the same global guard.\n- [ ] No duplicate `static ENV_LOCK` definitions remain in fixtures.\n- [ ] Running `cargo test -- --test-threads=8` does not show env-related flakiness.\n\n**Files:**\n- tests/fixtures/realtime.rs\n- tests/fixtures/store_dir.rs\n- tests/fixtures/mod.rs (or new tests/fixtures/env_guard.rs)\n- src/paths.rs (if using test-only override helpers)","id":"bd-d7g","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"tests: env var races across fixtures","type":"bug"}
{"_at":[1770936635696,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Warm-daemon non-JSON `bd show` regression benchmark is added.\n- [ ] Non-JSON `bd show` latency improves materially versus baseline on same dataset.\n- [ ] Optimization does not change output semantics or ordering.\n- [ ] Benchmark reports JSON vs non-JSON deltas for visibility.","created_at":[1770936635696,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nNon-JSON `bd show` is significantly slower than the JSON path in warm-daemon runs (roughly +80-100ms in local benchmark). `bd ready` is mostly fine, but interactive `show` render cost is visible and stacks with other latency sources.\n\nThis hurts the default human workflow because users mostly run non-JSON commands.","design":"Optimize non-JSON show path end-to-end:\n1. Profile CLI render pipeline and daemon query count for `bd show`.\n2. Collapse redundant IPC/queries and precompute display-oriented digest where appropriate.\n3. Avoid repeated expensive formatting steps for unchanged data.\n4. Add a non-JSON benchmark guardrail in CI/slow-tests for regressions.","id":"bd-o9qu","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"open","title":"Non-JSON bd show path is measurably slower than JSON path","type":"bug"}
