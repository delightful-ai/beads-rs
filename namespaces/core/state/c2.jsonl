{"_at":[1768416307751,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768411817049,1],"darin@book"],"claim":[[1768416250780,1],"darin@book"],"description":[[1768411817049,1],"darin@book"],"design":[[1768411817049,1],"darin@book"],"estimated_minutes":[[1768411817049,1],"darin@book"],"external_ref":[[1768411817049,1],"darin@book"],"labels":[[1768411817049,1],"darin@book"],"priority":[[1768411817049,1],"darin@book"],"source_repo":[[1768411817049,1],"darin@book"],"title":[[1768411817049,1],"darin@book"],"type":[[1768411817049,1],"darin@book"]},"assignee":"darin@book","assignee_at":[1768416250780,1],"assignee_expires":1768419850780,"closed_at":[1768416307751,1],"closed_by":"darin@book","created_at":[1768411817049,1],"created_by":"darin@book","description":"**Problem**\nTests that mutate global env use separate locks, so env changes are not serialized across the test suite. `tests/fixtures/realtime.rs` and `tests/fixtures/store_dir.rs` each define their own static `ENV_LOCK`, meaning concurrent tests can stomp on BD_DATA_DIR/XDG_RUNTIME_DIR and cause flakiness (especially with realtime phase tests that rely on RealtimeFixture). This also makes it unsafe to run `cargo test` with multiple threads.\n\nEvidence:\n- `tests/fixtures/realtime.rs` defines `static ENV_LOCK` (line 12) and sets XDG_RUNTIME_DIR/BD_DATA_DIR globally.\n- `tests/fixtures/store_dir.rs` defines a separate `static ENV_LOCK` (line 9) and sets BD_DATA_DIR globally.\n\n**Design**\n- Introduce a single global env guard (e.g., `tests/fixtures/env_guard.rs`) and have all fixtures that mutate env acquire it.\n- Alternatively, avoid global env mutation by using `paths::set_data_dir_for_tests` / `lock_data_dir_for_tests` for in-process tests and passing env per Command for CLI tests.\n- Remove duplicated ENV_LOCKs once the shared guard is in place.\n\n**Acceptance**\n- [ ] All tests that change env use the same global guard.\n- [ ] No duplicate `static ENV_LOCK` definitions remain in fixtures.\n- [ ] Running `cargo test -- --test-threads=8` does not show env-related flakiness.\n\n**Files:**\n- tests/fixtures/realtime.rs\n- tests/fixtures/store_dir.rs\n- tests/fixtures/mod.rs (or new tests/fixtures/env_guard.rs)\n- src/paths.rs (if using test-only override helpers)","id":"bd-d7g","labels":[],"priority":1,"status":"closed","title":"tests: env var races across fixtures","type":"bug"}
