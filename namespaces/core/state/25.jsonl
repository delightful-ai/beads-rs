{"_at":[1769574790928,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"Acceptance\n- Snapshot and manifest types use typed shard paths; invalid paths cannot be constructed.\n- build_snapshot/build_snapshot_from_state reject dirty_shards outside of shard set.\n- import_checkpoint rejects duplicate or out-of-order entries in state/tombstone/dep/note shards.\n- Tests cover path validation, dirty_shards subset enforcement, and duplicate-entry rejection.","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769563878222,0],"created_by":"darin@darinsmcstudio2.lan","description":"Problem\n- CheckpointSnapshot/CheckpointManifest store shard paths as raw String and dirty_shards as BTreeSet<String>.\n- Path validation is scattered (layout::parse_shard_path, import::validate_rel_path, publish tree builder).\n- Shard contents accept duplicates/unsorted lines; insert_live silently overwrites duplicates during import.\n\nImpact\n- A typo in dirty_shards can delete or skip unrelated files during incremental export.\n- Malformed shards can silently drop data (last write wins) instead of failing fast.\n- Violates parse-don't-validate and Scatter (path invariants live in multiple places).\n","design":"Design\n- Introduce validated newtypes: ShardName (\"[0-9a-f]{2}.jsonl\"), CheckpointShardPath { namespace, kind, shard: ShardName }.\n- Use CheckpointShardPath (not String) in CheckpointSnapshot.shards and dirty_shards; derive the string path only at the IO boundary.\n- Change CheckpointManifest.files to BTreeMap<CheckpointShardPath, ManifestFile> (or a thin CheckpointFilePath newtype).\n- Enforce dirty_shards ⊆ shards at construction (return error if not).\n- In import_checkpoint, add canonical validation for shard content:\n  - state shards: strictly increasing BeadId, no duplicates.\n  - tombstones: strictly increasing BeadId (or TombstoneKey) with no duplicates.\n  - deps: strictly increasing DepKey, no duplicates.\n  - notes: strictly increasing (bead_id, note_id) with no duplicates.\n- Keep ordering guarantees in export (already sorted) and assert in tests.\n\nScatter fit\n- Centralize path parsing/validation in one type; callers only handle typed paths.\n- Canonical ordering checks live in one parser per shard kind.\n\nFiles\n- crates/beads-rs/src/git/checkpoint/layout.rs\n- crates/beads-rs/src/git/checkpoint/types.rs\n- crates/beads-rs/src/git/checkpoint/manifest.rs\n- crates/beads-rs/src/git/checkpoint/export.rs\n- crates/beads-rs/src/git/checkpoint/import.rs\n- crates/beads-rs/src/git/checkpoint/publish.rs\n- crates/beads-rs/src/git/checkpoint/cache.rs","id":"bd-34oa","labels":{"cc":{"max":{}},"entries":{}},"notes":[{"at":[1769572811156,0],"author":"darin@darins-Mac-Studio-2.local","content":"Reminder: rendering should stay in command files; avoid moving rendering into shared helpers.","id":"go-comment-bd-34oa-1"},{"at":[1769574790928,0],"author":"darin@darinsmcstudio2.lan","content":"Reminder: rendering should stay in command files; avoid moving rendering into shared helpers.","id":"legacy-notes"}],"priority":1,"status":"closed","title":"checkpoint shards: type the paths and enforce canonical order","type":"bug"}
{"_at":[1768290954770,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] Broadcaster delivers events in order to subscribers and drops slow consumers when bounds exceeded.\n- [ ] Hot cache evicts by size and event count deterministically.\n- [ ] API exposes publish/subscribe with bounded channels and a drop reason.\n- [ ] Unit tests cover backpressure and eviction behavior.","assignee":"darin@darinsmacstudio.lan","created_at":[1768177887839,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nPhase 5: add a bounded EventBroadcaster and hot cache for recently appended events. There is no pub or sub mechanism to stream events or serve fast replication reads.\n\n**Context**\n- REALTIME_PLAN.md §7.5 (EventBroadcaster and hot cache requirements)\n**Files:** src/daemon/broadcast.rs (new) or src/daemon/store_runtime.rs","design":"**Design**\n- Implement a broadcaster that publishes EventId, sha, prev_sha, namespace, and canonical EventBody bytes.\n- Enforce bounds by events and bytes; drop slow subscribers with ERROR(code=\"subscriber_lagged\").\n- Maintain a FIFO hot cache with deterministic eviction.\n- Integrate publish after WAL append in StoreRuntime.","id":"bd-3m5.16","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Phase 5: EventBroadcaster + hot cache","type":"task"}
{"_at":[1769772690659,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1769309224735,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nValidation and normalization helpers are scattered in src/cli/mod.rs (lines 1327-1510), ~200 lines mixed with other code:\n\n- `normalize_bead_id()` (line 1351)\n- `normalize_bead_ids()` (line 1359)\n- `normalize_bead_id_for()` (line 1366)\n- `normalize_bead_slug_for()` (line 1368)\n- `normalize_optional_namespace()` (line 1399)\n- `normalize_optional_client_request_id()` (line 1420)\n- `apply_common_filters()` (line 1479)\n- `normalize_dep_specs()` (line 1499)\n\nThese handle CLI arg validation before sending to daemon. Extracting improves discoverability and enables reuse.\n\n**Design**\n1. Create `src/cli/validation.rs`\n2. Move all normalization/validation helpers there\n3. Include the `validation_error()` helper (from related bead) here\n4. Update imports\n\n```rust\n// src/cli/validation.rs\nuse crate::core::BeadId;\nuse crate::daemon::OpError;\nuse crate::Error;\n\npub(crate) fn validation_error(field: impl Into<String>, reason: impl Into<String>) -> Error { ... }\n\npub(crate) fn normalize_bead_id(id: &str) -> Result<BeadId, Error> { ... }\npub(crate) fn normalize_bead_ids(ids: &[String]) -> Result<Vec<BeadId>, Error> { ... }\npub(crate) fn normalize_bead_id_for(field: &str, id: &str) -> Result<BeadId, Error> { ... }\n// ... etc\n```\n\n**Design Notes**\n- This can be done independently of parsers.rs extraction\n- If validation_error() bead is done first, just move it here\n- apply_common_filters() may need to stay in mod.rs if it depends on Args types that arent extracted yet\n\n**Acceptance**\n- [ ] src/cli/validation.rs created\n- [ ] All normalize_* functions moved from mod.rs\n- [ ] validation_error() helper included (or imported if separate bead done first)\n- [ ] Command handlers import from validation module\n- [ ] cargo clippy passes\n- [ ] cargo test passes\n\n**Files:** src/cli/mod.rs, src/cli/validation.rs (new), src/cli/commands/*.rs","id":"bd-6gz5","labels":{"cc":{"max":{}},"entries":{}},"priority":3,"status":"closed","title":"Extract cli/validation.rs module for normalization helpers","type":"chore"}
