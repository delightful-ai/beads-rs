{"_at":[1768450000807,1],"_by":"darin@book","_v":{"acceptance_criteria":[[1768444153886,1],"darin@book"],"claim":[[1768449393982,1],"darin@book"],"description":[[1768444153886,1],"darin@book"],"design":[[1768444153886,1],"darin@book"],"estimated_minutes":[[1768444153886,1],"darin@book"],"external_ref":[[1768444153886,1],"darin@book"],"labels":[[1768444153886,1],"darin@book"],"priority":[[1768444153886,1],"darin@book"],"source_repo":[[1768444153886,1],"darin@book"],"title":[[1768444153886,1],"darin@book"],"type":[[1768444153886,1],"darin@book"]},"assignee":"darin@book","assignee_at":[1768449393982,1],"assignee_expires":1768452993982,"closed_at":[1768450000807,1],"closed_by":"darin@book","created_at":[1768444153886,1],"created_by":"darin@book","description":"**Problem**\nREALTIME_PLAN §5.5/§5.6 define an EventWal that owns the active segment per namespace and rotates by size/age. Current code opens a new SegmentWriter for every local mutation and every replication ingest batch, so each event/batch becomes its own segment and rotation logic is effectively bypassed. This contradicts the WAL design and inflates segment count + fsync dir overhead.\n\nEvidence:\n- src/daemon/executor.rs:225–255 creates SegmentWriter::open for each mutation (no reuse).\n- src/daemon/core.rs:1009–1033 (ingest_remote_batch) creates SegmentWriter::open per batch.\n- There is no EventWal struct managing active segments in src/daemon/wal/mod.rs.\n\n**Why this violates plan**\nPlan requires a long-lived EventWal that appends to the current segment, rotates when size/age thresholds are hit, and only fsyncs directories on rotation. Opening a new segment per event defeats these invariants.\n\n**Acceptance**\n- [ ] Introduce EventWal (per store) that keeps active SegmentWriter per namespace.\n- [ ] Use EventWal::append in executor + replication ingest; reuse active segment until rotation triggers.\n- [ ] Rotation honors max_segment_bytes/max_segment_age and only then creates new segment + dir fsync.\n- [ ] Tests cover multi-append into a single segment and rotation thresholds.","id":"bd-3m5.82","labels":[],"priority":1,"status":"closed","title":"Event WAL uses SegmentWriter per append; no persistent EventWal/segment reuse","type":"bug"}
