{"_at":[1770500523735,0],"_by":"darin@darinsmcstudio2.lan","acceptance_criteria":"- [ ] `store`/`update` commands use surface APIs\n- [ ] Behavior-compatible tests pass\n- [ ] No daemon-internal imports remain in migrated handlers","assignee":"darin@darins-Mac-Studio-2.local","created_at":[1770498234932,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nEven with new APIs, command handlers still need migration to eliminate daemon imports.","design":"Refactor command handlers to call only surface-level APIs and update tests accordingly.","id":"bd-21eg.15","labels":{"cc":{"max":{}},"entries":{}},"priority":1,"status":"closed","title":"Migrate CLI store/update commands to new surface APIs","type":"task"}
{"_at":[1768404782046,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@book","created_at":[1768180782214,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nPhase 4 implementation must be verified before Phase 5 starts.\n\n**Context**\n- REALTIME_PLAN.md §18: origin_seq allocation, idempotency mapping/receipts\n- Depends on: Phase 4 implementation + Phase 4 test infrastructure\n\n**Design**\nDeterministic tests for:\n- Idempotency: same client_request_id → same txn_id + event_ids on retry\n- Request hash mismatch: same client_request_id, different request → ERROR\n- Receipt min_seen: advances monotonically with watermarks\n- Receipt after restart: txn_id/event_ids preserved, durability_proof may differ\n- No duplicate origin_seq: crash + restart → next seq is max+1\n\n**Acceptance**\n- [ ] tests/phase4_idempotency.rs: idempotency mapping tests\n- [ ] tests/phase4_receipts.rs: receipt semantics tests\n- [ ] Test: request_sha256 mismatch returns error code\n- [ ] Test: receipt survives daemon restart\n- [ ] cargo test phase4_ passes\n\n**Files:** tests/phase4_idempotency.rs (new), tests/phase4_receipts.rs (new)","id":"bd-3m5.60","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Phase 4 tests: idempotency mapping + receipts","type":"task"}
{"_at":[1765786356990,0],"_by":"darin@darinsmcstudio2.lan","assignee":"darin@dusk","closed_reason":"Added LoadedRemote proof type. ensure_repo_loaded/fresh return LoadedRemote, repo_state/repo_state_mut take &LoadedRemote and are infallible. All .unwrap() calls on repo_state lookups removed.","created_at":[1765744417943,0],"created_by":"darin@darinsmcstudio2.lan","description":"**Problem**\nAfter `ensure_repo_loaded()`, we \"know\" the repo exists, but the type does not prove it:\n```rust\nlet remote = self.ensure_repo_loaded(repo, git_tx)?;\n// ... later ...\nlet repo_state = self.repo_state_mut(&remote).unwrap(); // \"I know it is there\"\n```\n\n**Design**\nCreate a proof type that can only be constructed by loading:\n```rust\n/// Proof that a repo is loaded. Only created by Daemon::ensure_repo_loaded.\npub struct LoadedRemote(RemoteUrl);\n\nimpl LoadedRemote {\n    pub fn remote(&self) -> &RemoteUrl { &self.0 }\n}\n\nimpl Daemon {\n    pub fn ensure_repo_loaded(&mut self, repo: &Path, git_tx: &Sender<GitOp>) \n        -> Result<LoadedRemote, OpError> \n    {\n        let remote = self.resolve_remote(repo)?;\n        // ... loading logic ...\n        Ok(LoadedRemote(remote))\n    }\n\n    /// Infallible because LoadedRemote proves existence\n    pub fn repo_state(&self, proof: &LoadedRemote) -> &RepoState {\n        self.repos.get(proof.remote())\n            .expect(\"LoadedRemote guarantees repo exists\")\n    }\n\n    pub fn repo_state_mut(&mut self, proof: &LoadedRemote) -> &mut RepoState {\n        self.repos.get_mut(proof.remote())\n            .expect(\"LoadedRemote guarantees repo exists\")\n    }\n}\n```\n\nThe `expect` is now documentation of a proven invariant, not a latent bug.\n\n**Acceptance**\n- [ ] `LoadedRemote` type exists in `src/daemon/mod.rs` or `src/daemon/state.rs`\n- [ ] `ensure_repo_loaded` returns `LoadedRemote`\n- [ ] `repo_state`/`repo_state_mut` take `&LoadedRemote` parameter\n- [ ] All `.unwrap()` calls on repo_state lookups in executor/query code are removed\n- [ ] Tests pass\n\n**Files:** src/daemon/mod.rs, src/daemon/executor.rs, src/daemon/query_executor.rs","id":"bd-roy","labels":{"cc":{"max":{}},"entries":{}},"priority":2,"status":"closed","title":"Add LoadedRemote proof type to eliminate repo_state unwraps","type":"chore"}
