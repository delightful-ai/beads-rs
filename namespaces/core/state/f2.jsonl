{"_at":[1768289552843,1],"_by":"darin@darinsmacstudio.lan","_v":{"acceptance_criteria":[[1768180588532,1],"darin@darinsmacstudio.lan"],"claim":[[1768288051300,1],"darin@darinsmacstudio.lan"],"description":[[1768180588532,1],"darin@darinsmacstudio.lan"],"design":[[1768180588532,1],"darin@darinsmacstudio.lan"],"estimated_minutes":[[1768178742774,1],"darin@darinsmacstudio.lan"],"external_ref":[[1768178742774,1],"darin@darinsmacstudio.lan"],"labels":[[1768178742774,1],"darin@darinsmacstudio.lan"],"priority":[[1768261542823,1],"darin@darinsmacstudio.lan"],"source_repo":[[1768178742774,1],"darin@darinsmacstudio.lan"],"title":[[1768185404005,1],"darin@darinsmacstudio.lan"],"type":[[1768178742774,1],"darin@darinsmacstudio.lan"]},"acceptance_criteria":"- [ ] Gap buffer enforces event and byte bounds and returns explicit Reject on overflow/timeout.\n- [ ] Only fully verified contiguous events are forwarded to WAL append.\n- [ ] Duplicate events are treated as no-ops without disturbing the buffer.\n- [ ] Unit tests cover: single gap, multiple gaps, overflow, timeout, deferred-prev behavior.","assignee":"darin@darinsmacstudio.lan","assignee_at":[1768288051300,1],"assignee_expires":1768291651300,"closed_at":[1768289552843,1],"closed_by":"darin@darinsmacstudio.lan","created_at":[1768178742774,1],"created_by":"darin@darinsmacstudio.lan","description":"**Problem**\nOut-of-order replication needs a bounded gap buffer that is aware of contiguity and prev hash verification. A naive BTreeMap of bytes lets callers accidentally treat deferred prev checks as safe and doesn’t encode the decision outcomes.\n\n**Context**\n- REALTIME_PLAN.md §9.4 (contiguous ingest rule), §9.8 (gap handling + bounds)\n- Stateright model: beads_stateright_models/src/realtime_types_sketch.rs (GapBuffer, VerifiedEventAny, IngestDecision)\n\n**Files:** src/daemon/repl/gap_buffer.rs (new), src/daemon/repl/session.rs, src/daemon/store_runtime.rs","design":"**Design**\n- Implement GapBufferByNsOrigin keyed by (NamespaceId, ReplicaId) with per-origin gap state.\n- Store VerifiedEventAny so deferred prev checks remain explicit; only contiguous VerifiedEvent<PrevVerified> are forwarded to WAL append.\n- Provide ingest API returning an IngestDecision: ForwardContiguousBatch, BufferedNeedWant, DuplicateNoop, Reject(code).\n- Enforce per-origin bounds on buffered events and bytes, plus a timeout window; overflow or timeout returns Reject(\"gap_buffer_overflow\"/\"gap_timeout\").\n- Drain buffered suffix in order when the predecessor arrives; stop if a deferred event is still waiting on prev verification.","id":"bd-3m5.28","labels":[],"priority":1,"status":"closed","title":"Phase 5: GapBufferByNsOrigin for replication","type":"task"}
